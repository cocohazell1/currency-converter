<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- ì›¹ ì•± ì„¤ì •ì„ ìœ„í•œ ë©”íƒ€ íƒœê·¸ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="í™˜ìœ¨ ê³„ì‚°ê¸°">
    
    <!-- ì•„ì´í° í™ˆ í™”ë©´ ì•„ì´ì½˜ -->
    <link rel="apple-touch-icon" href="https://i.ibb.co/mRpP36p/currency-icon.png">
    
    <!-- Google AdSense ìŠ¤í¬ë¦½íŠ¸ (ë‚˜ì¤‘ì— ì±„ì›Œë„£ì„ ë¶€ë¶„) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=YOUR_ADSENSE_CLIENT_ID"
     crossorigin="anonymous"></script>

    <title>ë“€ì–¼ ëª¨ë“œ í™˜ìœ¨ ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Cairo:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Noto Sans JP', 'Cairo', sans-serif;
            background-color: #f0f2f5;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .draggable-item { user-select: none; }
        .drag-handle { cursor: grab; touch-action: none; }
        .dragging {
            opacity: 0.7;
            background: #e0e7ff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        /* ìë™ ë†’ì´ ì¡°ì ˆ textarea */
        .autoresize-textarea {
            resize: none;
            overflow: hidden;
            min-height: 44px; /* ì´ˆê¸° ë†’ì´ */
        }
        /* ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mode-btn {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        /* ìƒë‹¨ ê³ ì • ìŠ¤íƒ€ì¼ (ê²½ë¹„ í•©ì‚° ëª¨ë“œ) */
        #currency-list.expense-mode > .draggable-item:first-child {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        /* ê´‘ê³  ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .ad-container {
            min-height: 100px; /* ê´‘ê³  ë¡œë”© ì „ ìµœì†Œ ë†’ì´ */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            color: #9ca3af;
            font-size: 0.875rem;
            text-align: center;
            margin: 1rem 0;
            width: 100%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full h-full max-w-lg bg-white rounded-none sm:rounded-2xl shadow-none sm:shadow-xl">
        <div id="main-content" class="p-6 md:p-8 pb-32"> <!-- í•˜ë‹¨ í•©ê³„ ì˜ì—­ì„ ìœ„í•œ íŒ¨ë”© ì¶”ê°€ -->
            <!-- í—¤ë” -->
            <div class="relative text-center mb-4 pt-4">
                <h1 id="app-title" class="text-3xl font-bold text-gray-800" data-translate-key="title">ë“€ì–¼ ëª¨ë“œ ê³„ì‚°ê¸°</h1>
                <div id="rate-info" class="text-sm text-gray-600 my-3">
                    <p id="base-rate-display">1 USD = 0.00 KRW</p>
                    <div class="flex justify-center items-center gap-2 mt-1">
                         <p id="last-updated" data-translate-key="last_updated">ìµœì¢… ì—…ë°ì´íŠ¸: -</p>
                         <div dir="ltr">
                             <select id="language-selector" class="bg-gray-100 border border-gray-300 rounded-md p-1 text-xs focus:ring-blue-500 focus:border-blue-500">
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="en">English</option>
                                <option value="ja">æ—¥æœ¬èª</option>
                                <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                                <option value="es">EspaÃ±ol</option>
                                <option value="fr">FranÃ§ais</option>
                                <option value="de">Deutsch</option>
                                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            </select>
                         </div>
                    </div>
                </div>
            </div>

            <!-- ëª¨ë“œ ì„ íƒ ë²„íŠ¼ -->
            <div class="grid grid-cols-2 gap-2 p-1 bg-gray-200 rounded-lg mb-4">
                <button id="mode-expense" class="mode-btn font-bold py-2 rounded-md transition-colors" data-translate-key="mode_expense">ê²½ë¹„ í•©ì‚°</button>
                <button id="mode-converter" class="mode-btn font-bold py-2 rounded-md transition-colors" data-translate-key="mode_converter">í™˜ìœ¨ ë³€í™˜</button>
            </div>
             <p id="mode-tip" class="text-xs text-center text-blue-600 bg-blue-50 p-2 rounded-lg mb-4" data-translate-key="tip_expense">
                ğŸ’¡ íŒ: ì…ë ¥ì°½ì— `100 + 50 - 10%` ì²˜ëŸ¼ ê³„ì‚°í•  ìˆ˜ ìˆì–´ìš”!
            </p>

            <div id="loader" class="flex justify-center items-center h-60">
                <div class="loader"></div>
            </div>
            
            <div id="calculator" class="hidden">
                <div id="currency-list" class="space-y-4">
                    <!-- í†µí™” ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-700 rounded-lg">
                <p data-translate-key="error_message">í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
            </div>
        </div>

        <!-- ì´ í•©ê³„ ê³ ì • í‘¸í„° -->
        <div id="total-summary-footer" class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-blue-600 text-white p-4 shadow-lg rounded-t-2xl hidden">
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold" data-translate-key="total_sum">ì´ í•©ê³„</span>
                <span id="total-amount-display" class="text-2xl font-bold">â‚© 0</span>
            </div>
            <button id="reset-button" class="w-full mt-3 bg-white text-blue-600 font-bold py-2 rounded-lg hover:bg-gray-100 transition" data-translate-key="reset_button">ëª¨ë“  ì…ë ¥ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContent = document.getElementById('main-content');
            const currencyListContainer = document.getElementById('currency-list');
            const lastUpdated = document.getElementById('last-updated');
            const baseRateDisplay = document.getElementById('base-rate-display');
            const loader = document.getElementById('loader');
            const calculator = document.getElementById('calculator');
            const errorMessage = document.getElementById('error-message');
            const totalSummaryFooter = document.getElementById('total-summary-footer');
            const totalAmountDisplay = document.getElementById('total-amount-display');
            const resetButton = document.getElementById('reset-button');
            const modeExpenseBtn = document.getElementById('mode-expense');
            const modeConverterBtn = document.getElementById('mode-converter');
            const modeTip = document.getElementById('mode-tip');
            const languageSelector = document.getElementById('language-selector');

            const translations = {
                ko: { title: "ë“€ì–¼ ëª¨ë“œ ê³„ì‚°ê¸°", last_updated: "ìµœì¢… ì—…ë°ì´íŠ¸:", mode_expense: "ê²½ë¹„ í•©ì‚°", mode_converter: "í™˜ìœ¨ ë³€í™˜", tip_expense: "ğŸ’¡ ì‚¬ìš©ë²•: ë§¨ ìœ„ í†µí™”ê°€ í•©ê³„ ê¸°ì¤€ì…ë‹ˆë‹¤. ì†ì¡ì´(â˜°)ë¥¼ ëŒì–´ ìˆœì„œë¥¼ ë°”ê¾¸ê³ , `10+10-10%`ì²˜ëŸ¼ ê³„ì‚°ì‹ì„ ì…ë ¥í•˜ì„¸ìš”!", tip_converter: "ğŸ’¡ íŒ: í•œ í†µí™”ì— ê°’ì„ ì…ë ¥í•˜ë©´ ë‚˜ë¨¸ì§€ê°€ ëª¨ë‘ ë³€í™˜ë©ë‹ˆë‹¤.", error_message: "í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", total_sum: "ì´ í•©ê³„", reset_button: "ëª¨ë“  ì…ë ¥ ì´ˆê¸°í™”" },
                en: { title: "Dual Mode Calculator", last_updated: "Last Updated:", mode_expense: "Expense Sum", mode_converter: "Converter", tip_expense: "ğŸ’¡ How to use: The top currency is the sum's base. Drag the handle (â˜°) to reorder and enter calculations like `10+10-10%`!", tip_converter: "ğŸ’¡ Tip: Enter a value in one currency to convert all others.", error_message: "Failed to load exchange rates. Please try again later.", total_sum: "Total Sum", reset_button: "Reset All Inputs" },
                ja: { title: "ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰è¨ˆç®—æ©Ÿ", last_updated: "æœ€çµ‚æ›´æ–°:", mode_expense: "çµŒè²»åˆç®—", mode_converter: "ç‚ºæ›¿å¤‰æ›", tip_expense: "ğŸ’¡ä½¿ã„æ–¹: ä¸€ç•ªä¸Šã®é€šè²¨ãŒåˆè¨ˆã®åŸºæº–ã§ã™ã€‚ãƒãƒ³ãƒ‰ãƒ«(â˜°)ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºã‚’å¤‰ãˆã€`10+10-10%`ã®ã‚ˆã†ã«è¨ˆç®—å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼", tip_converter: "ğŸ’¡ãƒ’ãƒ³ãƒˆï¼šä¸€ã¤ã®é€šè²¨ã«å€¤ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ä»–ãŒã™ã¹ã¦å¤‰æ›ã•ã‚Œã¾ã™ã€‚", error_message: "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", total_sum: "åˆè¨ˆ", reset_button: "ã™ã¹ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ" },
                zh: { title: "åŒæ¨¡å¼è®¡ç®—å™¨", last_updated: "æœ€åæ›´æ–°:", mode_expense: "è´¹ç”¨åˆè®¡", mode_converter: "æ±‡ç‡æ¢ç®—", tip_expense: "ğŸ’¡ ä½¿ç”¨æ–¹æ³•: æœ€ä¸Šæ–¹çš„è´§å¸æ˜¯æ€»è®¡çš„åŸºå‡†ã€‚æ‹–åŠ¨æŠŠæ‰‹(â˜°)é‡æ–°æ’åºï¼Œå¹¶åƒ `10+10-10%` ä¸€æ ·è¾“å…¥è®¡ç®—ï¼", tip_converter: "ğŸ’¡ æç¤ºï¼šåœ¨ä¸€ä¸ªè´§å¸ä¸­è¾“å…¥ä¸€ä¸ªå€¼ï¼Œæ‰€æœ‰å…¶ä»–è´§å¸éƒ½ä¼šè½¬æ¢ã€‚", error_message: "åŠ è½½æ±‡ç‡å¤±è´¥ã€‚è¯·ç¨åå†è¯•ã€‚", total_sum: "æ€»è®¡", reset_button: "é‡ç½®æ‰€æœ‰è¾“å…¥" },
                es: { title: "Calculadora Modo Dual", last_updated: "Ãšltima actualizaciÃ³n:", mode_expense: "Suma de Gastos", mode_converter: "Convertidor", tip_expense: "ğŸ’¡ CÃ³mo usar: La moneda superior es la base de la suma. Â¡Arrastra el asa (â˜°) para reordenar e introduce cÃ¡lculos como `10+10-10%`!", tip_converter: "ğŸ’¡ Consejo: Introduce un valor en una moneda para convertir todas las demÃ¡s.", error_message: "Error al cargar las tasas de cambio. Por favor, intÃ©ntalo de nuevo mÃ¡s tarde.", total_sum: "Suma Total", reset_button: "Restablecer Todo" },
                fr: { title: "Calculatrice Double Mode", last_updated: "DerniÃ¨re mise Ã  jour:", mode_expense: "Somme des DÃ©penses", mode_converter: "Convertisseur", tip_expense: "ğŸ’¡ Comment utiliser : La devise du haut est la base de la somme. Faites glisser la poignÃ©e (â˜°) pour rÃ©organiser et entrez des calculs comme `10+10-10%` !", tip_converter: "ğŸ’¡ Astuce : Entrez une valeur dans une devise pour convertir toutes les autres.", error_message: "Ã‰chec du chargement des taux de change. Veuillez rÃ©essayer plus tard.", total_sum: "Somme Totale", reset_button: "RÃ©initialiser Tout" },
                de: { title: "Dual-Modus-Rechner", last_updated: "Letzte Aktualisierung:", mode_expense: "Ausgabensumme", mode_converter: "Umrechner", tip_expense: "ğŸ’¡ Anleitung: Die oberste WÃ¤hrung ist die Basis fÃ¼r die Summe. Ziehen Sie den Griff (â˜°), um die Reihenfolge zu Ã¤ndern, und geben Sie Berechnungen wie `10+10-10%` ein!", tip_converter: "ğŸ’¡ Tipp: Geben Sie einen Wert in einer WÃ¤hrung ein, um alle anderen umzurechnen.", error_message: "Fehler beim Laden der Wechselkurse. Bitte versuchen Sie es spÃ¤ter erneut.", total_sum: "Gesamtsumme", reset_button: "Alles zurÃ¼cksetzen" },
                ar: { title: "Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø© Ø¨ÙˆØ¶Ø¹ Ù…Ø²Ø¯ÙˆØ¬", last_updated: "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:", mode_expense: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ", mode_converter: "Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª", tip_expense: "ğŸ’¡ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ù‡ÙŠ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹. Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù‚Ø¨Ø¶ (â˜°) Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ£Ø¯Ø®Ù„ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø«Ù„ `10+10-10%`!", tip_converter: "ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰.", error_message: "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚.", total_sum: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", reset_button: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„" },
            };
            
            const targetCurrencies = {
                'KRW': { country: 'kr', name: 'ëŒ€í•œë¯¼êµ­ ì›', symbol: 'â‚©' },'JPY': { country: 'jp', name: 'ì¼ë³¸ ì—”', symbol: 'Â¥' },'CNY': { country: 'cn', name: 'ì¤‘êµ­ ìœ„ì•ˆ', symbol: 'Â¥' },'HKD': { country: 'hk', name: 'í™ì½© ë‹¬ëŸ¬', symbol: '$' },'SGD': { country: 'sg', name: 'ì‹±ê°€í¬ë¥´ ë‹¬ëŸ¬', symbol: '$' },'THB': { country: 'th', name: 'íƒœêµ­ ë°”íŠ¸', symbol: 'à¸¿' },'VND': { country: 'vn', name: 'ë² íŠ¸ë‚¨ ë™', symbol: 'â‚«' },'IDR': { country: 'id', name: 'ì¸ë„ë„¤ì‹œì•„ ë£¨í”¼ì•„', symbol: 'Rp' },'PHP': { country: 'ph', name: 'í•„ë¦¬í•€ í˜ì†Œ', symbol: 'â‚±' },'MYR': { country: 'my', name: 'ë§ë ˆì´ì‹œì•„ ë§ê¹ƒ', symbol: 'RM' },'INR': { country: 'in', name: 'ì¸ë„ ë£¨í”¼', symbol: 'â‚¹' },'KHR': { country: 'kh', name: 'ìº„ë³´ë””ì•„ ë¦¬ì—˜', symbol: 'áŸ›' },'LAK': { country: 'la', name: 'ë¼ì˜¤ìŠ¤ í‚µ', symbol: 'â‚­' },'USD': { country: 'us', name: 'ë¯¸êµ­ ë‹¬ëŸ¬', symbol: '$' },'CAD': { country: 'ca', name: 'ìºë‚˜ë‹¤ ë‹¬ëŸ¬', symbol: '$' },'MXN': { country: 'mx', name: 'ë©•ì‹œì½” í˜ì†Œ', symbol: '$' },'BRL': { country: 'br', name: 'ë¸Œë¼ì§ˆ í—¤ì•Œ', symbol: 'R$' },'ARS': { country: 'ar', name: 'ì•„ë¥´í—¨í‹°ë‚˜ í˜ì†Œ', symbol: '$' },'CLP': { country: 'cl', name: 'ì¹ ë ˆ í˜ì†Œ', symbol: '$' },'COP': { country: 'co', name: 'ì½œë¡¬ë¹„ì•„ í˜ì†Œ', symbol: '$' },'PEN': { country: 'pe', name: 'í˜ë£¨ ì†”', symbol: 'S/.' },'EUR': { country: 'eu', name: 'ìœ ëŸ½ ìœ ë¡œ', symbol: 'â‚¬' },'GBP': { country: 'gb', name: 'ì˜êµ­ íŒŒìš´ë“œ', symbol: 'Â£' },'CHF': { country: 'ch', name: 'ìŠ¤ìœ„ìŠ¤ í”„ë‘', symbol: 'Fr' },'TRY': { country: 'tr', name: 'í„°í‚¤ ë¦¬ë¼', symbol: 'â‚º' },'PLN': { country: 'pl', name: 'í´ë€ë“œ ì¦ˆì›Œí‹°', symbol: 'zÅ‚' },'CZK': { country: 'cz', name: 'ì²´ì½” ì½”ë£¨ë‚˜', symbol: 'KÄ' },'HUF': { country: 'hu', name: 'í—ê°€ë¦¬ í¬ë¦°íŠ¸', symbol: 'Ft' },'BAM': { country: 'ba', name: 'ë³´ìŠ¤ë‹ˆì•„ ë§ˆë¥´ì¹´', symbol: 'KM' },'RSD': { country: 'rs', name: 'ì„¸ë¥´ë¹„ì•„ ë””ë‚˜ë¥´', symbol: 'din' },'MKD': { country: 'mk', name: 'ë¶ë§ˆì¼€ë„ë‹ˆì•„ ë°ë‚˜ë¥´', symbol: 'Ğ´ĞµĞ½' },'ALL': { country: 'al', name: 'ì•Œë°”ë‹ˆì•„ ë ‰', symbol: 'L' },'BGN': { country: 'bg', name: 'ë¶ˆê°€ë¦¬ì•„ ë ˆí”„', symbol: 'Ğ»Ğ²' },'RON': { country: 'ro', name: 'ë£¨ë§ˆë‹ˆì•„ ë ˆìš°', symbol: 'lei' },'MDL': { country: 'md', name: 'ëª°ë„ë°” ë ˆìš°', symbol: 'L' },'GEL': { country: 'ge', name: 'ì¡°ì§€ì•„ ë¼ë¦¬', symbol: 'â‚¾' },'NOK': { country: 'no', name: 'ë…¸ë¥´ì›¨ì´ í¬ë¡œë„¤', symbol: 'kr' },'SEK': { country: 'se', name: 'ìŠ¤ì›¨ë´ í¬ë¡œë‚˜', symbol: 'kr' },'DKK': { country: 'dk', name: 'ë´ë§ˆí¬ í¬ë¡œë„¤', symbol: 'kr' },'AUD': { country: 'au', name: 'í˜¸ì£¼ ë‹¬ëŸ¬', symbol: '$' },'NZD': { country: 'nz', name: 'ë‰´ì§ˆëœë“œ ë‹¬ëŸ¬', symbol: '$' },'AED': { country: 'ae', name: 'UAE ë””ë¥´í•¨', symbol: 'Ø¯.Ø¥' },'ILS': { country: 'il', name: 'ì´ìŠ¤ë¼ì—˜ ì…°ì¼ˆ', symbol: 'â‚ª' },'EGP': { country: 'eg', name: 'ì´ì§‘íŠ¸ íŒŒìš´ë“œ', symbol: 'EÂ£' },'ZAR': { country: 'za', name: 'ë‚¨ì•„ê³µ ëœë“œ', symbol: 'R' },
            };
            
            let exchangeRates = {};
            let currentMode = 'expense';
            let currentLang = 'ko';
            let lastUpdateTimeUTC;
            let currencyOrder = Object.keys(targetCurrencies);

            async function fetchRates() {
                try {
                    const response = await fetch('https://open.er-api.com/v6/latest/USD');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    if (data.result === 'success') {
                        exchangeRates = data.rates;
                        lastUpdateTimeUTC = data.time_last_update_utc;
                        const savedLang = localStorage.getItem('preferredLanguage') || 'ko';
                        languageSelector.value = savedLang;
                        setLanguage(savedLang);
                        addModeSwitchListeners();
                        showCalculator();
                    } else { showError(); }
                } catch (error) { console.error('Error fetching exchange rates:', error); showError(); }
            }

            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('preferredLanguage', lang);
                languageSelector.value = lang;
                document.documentElement.lang = lang;
                document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if(translations[lang] && translations[lang][key]) { el.textContent = translations[lang][key]; }
                });
                if(lastUpdateTimeUTC) {
                    const updateDate = new Date(lastUpdateTimeUTC);
                    const lastUpdatedPrefix = translations[lang].last_updated || "Last Updated:";
                    lastUpdated.textContent = `${lastUpdatedPrefix} ${updateDate.toLocaleString(lang)}`;
                }
                setMode(currentMode);
            }
            
            languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
            
            function setMode(newMode) { currentMode = newMode; buildCalculatorUI(); addDragAndDropListeners(); updateModeUI(); }
            
            function updateModeUI() {
                currencyListContainer.className = currentMode === 'expense' ? 'expense-mode space-y-4' : 'converter-mode space-y-4';
                if(currentMode === 'expense') {
                    modeExpenseBtn.classList.add('active'); modeConverterBtn.classList.remove('active'); totalSummaryFooter.classList.remove('hidden');
                    mainContent.style.paddingBottom = '8rem';
                    modeTip.dataset.translateKey = 'tip_expense';
                } else {
                    modeConverterBtn.classList.add('active'); modeExpenseBtn.classList.remove('active'); totalSummaryFooter.classList.add('hidden');
                     mainContent.style.paddingBottom = '2rem';
                    modeTip.dataset.translateKey = 'tip_converter';
                }
                modeTip.textContent = translations[currentLang][modeTip.dataset.translateKey];
            }
            
            function addModeSwitchListeners() { modeExpenseBtn.addEventListener('click', () => setMode('expense')); modeConverterBtn.addEventListener('click', () => setMode('converter')); }
            
            function createAdPlaceholder() {
                const adContainer = document.createElement('div');
                adContainer.className = 'ad-container';
                adContainer.innerHTML = `
                    <ins class="adsbygoogle needs-ad-push"
                         style="display:block"
                         data-ad-format="auto"
                         data-full-width-responsive="true"
                         data-ad-client="YOUR_ADSENSE_CLIENT_ID"
                         data-ad-slot="YOUR_AD_SLOT_ID"></ins>
                `;
                return adContainer;
            }

            function createCurrencyCard(code) {
                const currency = targetCurrencies[code]; const card = document.createElement('div');
                const inputElement = currentMode === 'expense'
                    ? `<textarea class="autoresize-textarea currency-input w-full bg-white text-right font-semibold text-lg text-gray-800 rounded-md py-2 pl-8 pr-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-currency-code="${code}" placeholder="0" rows="1"></textarea>`
                    : `<input type="text" inputmode="decimal" class="currency-input w-full bg-white text-right font-semibold text-lg text-gray-800 rounded-md py-2 pl-8 pr-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-currency-code="${code}" placeholder="0.00">`;
                card.className = `flex items-center gap-3 p-3 bg-gray-50 rounded-xl border-2 border-transparent transition-shadow duration-300 draggable-item`;
                card.innerHTML = `<div class="drag-handle"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div><img src="https://flagcdn.com/w40/${currency.country}.png" alt="${currency.name} êµ­ê¸°" class="w-10 h-10 rounded-full shadow-sm" onerror="this.style.display='none'"><div class="flex-grow"><p class="font-bold text-gray-800">${code}</p><p class="text-sm text-gray-500">${currency.name}</p></div><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg">${currency.symbol}</span>${inputElement}</div>`;
                return card;
            }
            
            function buildCalculatorUI() {
                currencyListContainer.innerHTML = ''; 
                const finalOrder = currencyOrder;
                
                finalOrder.forEach((code, index) => {
                    currencyListContainer.appendChild(createCurrencyCard(code));
                    if (currentMode === 'expense' && (index === 5 || index === 15)) {
                        currencyListContainer.appendChild(createAdPlaceholder());
                    }
                });
                
                document.querySelectorAll('.currency-input').forEach(input => {
                    if(currentMode === 'expense') { input.addEventListener('input', (e) => { updateTotalAmount(); autoResizeTextarea(e.target); }); }
                    else { input.addEventListener('input', handleConverterInput); }
                });

                if (currentMode === 'expense') { 
                    resetButton.onclick = () => { document.querySelectorAll('.currency-input').forEach(input => { input.value = ''; autoResizeTextarea(input); }); updateTotalAmount(); };
                }
                
                // ê´‘ê³  ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê°œì„ ëœ ë°©ì‹)
                requestAnimationFrame(() => {
                    document.querySelectorAll('.adsbygoogle.needs-ad-push').forEach(ad => {
                        try {
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            ad.classList.remove('needs-ad-push');
                        } catch (e) {
                            if(ad.parentElement) ad.parentElement.style.display = 'none';
                            console.error("AdSense push error:", e);
                        }
                    });
                });

                updateBaseRateDisplay();
            }
            
            function autoResizeTextarea(textarea) { if (textarea.tagName && textarea.tagName.toLowerCase() === 'textarea') { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; } }
            
            function addDragAndDropListeners() {
                const container = document.getElementById('currency-list');
                if (!container) return;
                
                let draggingEl = null;

                function onPointerDown(e) {
                    const handle = e.target.closest('.drag-handle');
                    if (!handle) return;
                    draggingEl = handle.closest('.draggable-item');
                    if (!draggingEl) return;
                    draggingEl.classList.add('dragging');
                    if (e.type === 'mousedown') {
                        document.addEventListener('mousemove', onPointerMove);
                        document.addEventListener('mouseup', onPointerUp);
                    } else { // touchstart
                        document.addEventListener('touchmove', onPointerMove, { passive: false });
                        document.addEventListener('touchend', onPointerUp);
                    }
                }

                function onPointerMove(e) {
                    if (!draggingEl) return;
                    e.preventDefault();
                    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    const afterElement = getDragAfterElement(container, clientY);
                    if (afterElement) {
                        container.insertBefore(draggingEl, afterElement);
                    } else {
                        container.appendChild(draggingEl);
                    }
                }

                function onPointerUp() {
                    if (!draggingEl) return;
                    draggingEl.classList.remove('dragging');
                    draggingEl = null;
                    document.removeEventListener('mousemove', onPointerMove);
                    document.removeEventListener('mouseup', onPointerUp);
                    document.removeEventListener('touchmove', onPointerMove);
                    document.removeEventListener('touchend', onPointerUp);
                    currencyOrder = Array.from(container.querySelectorAll('.draggable-item')).map(item => item.querySelector('.currency-input').dataset.currencyCode);
                    updateBaseRateDisplay();
                    updateTotalAmount();
                }
                
                container.addEventListener('mousedown', onPointerDown);
                container.addEventListener('touchstart', onPointerDown, { passive: true });
            }
            
            function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
            
            function evaluateExpression(str) { if (!str || str.trim() === '') return 0; let evalStr = str.replace(/[\n\r]/g, ' ').replace(/[^0-9\.\+\-\*\/\(\)\%\s]/g, '').trim(); if (/[+\-*/]$/.test(evalStr)) evalStr = evalStr.slice(0, -1).trim(); if (evalStr === '') return 0; evalStr = evalStr.replace(/(\d*\.?\d+)\s*([+\-])\s*(\d*\.?\d+)\s*%/g, (m, p1, p2, p3) => `${p1} ${p2} (${p1} * ${p3} / 100)`); evalStr = evalStr.replace(/(\d*\.?\d+)\s*%/g, '( $1 / 100 )'); try { return new Function('return ' + evalStr)(); } catch (e) { return 0; } }
            
            function updateBaseRateDisplay() {
                const firstCardInput = document.querySelector('#currency-list .currency-input');
                if (!firstCardInput) return;
                const baseCode = firstCardInput.dataset.currencyCode;
                let quoteCode = 'USD';
                if (baseCode === 'USD') quoteCode = 'EUR';
                if (!exchangeRates[quoteCode] || !exchangeRates[baseCode]) return;
                const rate = exchangeRates[quoteCode] / exchangeRates[baseCode];
                baseRateDisplay.textContent = `1 ${baseCode} = ${rate.toFixed(4)} ${quoteCode}`;
            }

            function updateTotalAmount() {
                if (currentMode !== 'expense') return;
                const firstCardInput = document.querySelector('#currency-list .currency-input');
                if (!firstCardInput) return;
                const baseCurrencyCode = firstCardInput.dataset.currencyCode;
                let totalUSD = 0;
                document.querySelectorAll('.currency-input').forEach(input => {
                    const code = input.dataset.currencyCode; const value = evaluateExpression(input.value);
                    if (!isNaN(value) && value > 0) { if (exchangeRates[code]) { totalUSD += value / exchangeRates[code]; } }
                });
                if (!exchangeRates[baseCurrencyCode]) return;
                const totalInBaseCurrency = totalUSD * exchangeRates[baseCurrencyCode];
                const baseSymbol = targetCurrencies[baseCurrencyCode].symbol;
                totalAmountDisplay.textContent = `${baseSymbol} ${Math.round(totalInBaseCurrency).toLocaleString('ko-KR')}`;
            }
            
            function handleConverterInput(event) {
                const sourceInput = event.target; const sourceCode = sourceInput.dataset.currencyCode; const sourceValue = parseFloat(sourceInput.value.replace(/,/g, ''));
                if(isNaN(sourceValue)) { document.querySelectorAll('.currency-input').forEach(input => { if(input !== sourceInput) input.value = ''; }); return; }
                const sourceValueInUSD = sourceValue / exchangeRates[sourceCode];
                document.querySelectorAll('.currency-input').forEach(input => { if(input !== sourceInput) { const targetCode = input.dataset.currencyCode; if(!exchangeRates[targetCode]) return; const targetValue = sourceValueInUSD * exchangeRates[targetCode]; input.value = targetValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); } });
            }
            
            function showCalculator() { loader.classList.add('hidden'); errorMessage.classList.add('hidden'); calculator.classList.remove('hidden'); }
            function showError() { loader.classList.add('hidden'); calculator.classList.add('hidden'); errorMessage.classList.remove('hidden'); }
            
            fetchRates();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="í™˜ìœ¨ ê³„ì‚°ê¸°">
    <link rel="apple-touch-icon" href="https://i.ibb.co/mRpP36p/currency-icon.png">
    <title>í™˜ìœ¨ ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Cairo:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Noto Sans JP', 'Cairo', sans-serif;
            background-color: #f0f2f5;
        }
        .loader-container {
            text-align: center;
            color: #4b5563;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .currency-item {
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .drag-handle {
            cursor: grab;
            touch-action: none;
        }
        .dragging {
            opacity: 0.9;
            background: #e0e7ff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            z-index: 50;
            transform: scale(1.02);
        }
        .drop-placeholder {
            height: 60px;
            background-color: #e0e7ff;
            border: 2px dashed #9ca3af;
            border-radius: 0.75rem;
            margin: 0.5rem 0;
        }
        body.is-dragging {
            user-select: none;
            -webkit-user-select: none;
        }
        .autoresize-textarea {
            resize: none;
            overflow: hidden;
            min-height: 44px;
        }
        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mode-btn {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        #currency-list > .currency-item:first-child {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .offline-indicator {
            background-color: #fef2f2;
            color: #b91c1c;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            display: inline-block;
        }
        .blog-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: #3b82f6;
            text-decoration: underline;
            font-size: 0.875rem;
        }
        .blog-link:hover {
            color: #2563eb;
        }
        .copy-feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7176433427131791"
     crossorigin="anonymous"></script>
</head>
<body class="min-h-screen">
<div class="w-full h-full max-w-lg mx-auto bg-white rounded-none sm:rounded-2xl shadow-none sm:shadow-xl">
    <div id="main-content" class="p-6 md:p-8 pb-32">
        <div class="relative text-center mb-4 pt-4">
            <h1 id="app-title" class="text-3xl font-bold text-gray-800" data-translate-key="title">í™˜ìœ¨ ê³„ì‚°ê¸°</h1>
            <div id="rate-info" class="text-sm text-gray-600 my-3">
                <p id="base-rate-display">1 USD = 0.00 KRW</p>
                <div class="flex justify-center items-center gap-2 mt-1">
                    <p id="last-updated" data-translate-key="last_updated">ìµœì¢… ì—…ë°ì´íŠ¸: -</p>
                    <div dir="ltr">
                        <select id="language-selector" class="bg-gray-100 border border-gray-300 rounded-md p-1 text-xs focus:ring-blue-500 focus:border-blue-500">
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="en">English</option>
                            <option value="ja">æ—¥æœ¬èª</option>
                            <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                            <option value="es">EspaÃ±ol</option>
                            <option value="fr">FranÃ§ais</option>
                            <option value="de">Deutsch</option>
                            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                            <option value="ka">áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜</option>
                            <option value="vi">Tiáº¿ng Viá»‡t</option>
                            <option value="th">à¹„à¸—à¸¢</option>
                            <option value="km">ááŸ’á˜áŸ‚áš</option>
                            <option value="pt">PortuguÃªs</option>
                        </select>
                    </div>
                </div>
                <a href="https://blog.naver.com/nohassle" target="_blank" class="blog-link" data-translate-key="blog_link">ë¸”ë¡œê·¸ ë°©ë¬¸í•˜ê¸°</a>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-200 rounded-lg mb-4">
            <button id="mode-expense" class="mode-btn font-bold py-2 rounded-md transition-colors" data-translate-key="mode_expense" aria-pressed="true">ê²½ë¹„ í•©ì‚°</button>
            <button id="mode-converter" class="mode-btn font-bold py-2 rounded-md transition-colors" data-translate-key="mode_converter" aria-pressed="false">í™˜ìœ¨ ë³€í™˜</button>
        </div>
        <p id="mode-tip" class="text-xs text-center text-blue-600 bg-blue-50 p-2 rounded-lg mb-4" data-translate-key="tip_expense">
            ğŸ’¡ íŒ: ì…ë ¥ì°½ì— `100+50*95%` ì²˜ëŸ¼ ê³„ì‚°í•  ìˆ˜ ìˆì–´ìš”!
        </p>
        <div id="loader" class="flex justify-center items-center h-60">
             <div class="loader-container">
                <div class="loader"></div>
                <p data-translate-key="loading">í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
        <div id="calculator" class="hidden">
            <div id="currency-list" class="space-y-4"></div>
        </div>
        <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-700 rounded-lg">
            <p data-translate-key="error_message">í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
            <button id="retry-button" class="mt-3 bg-red-700 text-white px-4 py-2 rounded-md text-sm hover:bg-red-800 transition-colors" data-translate-key="retry_button">ë‹¤ì‹œ ì‹œë„</button>
        </div>
    </div>
    <div id="total-summary-footer" class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-blue-600 text-white p-4 shadow-lg rounded-t-2xl hidden">
        <div class="flex justify-between items-center">
            <span class="text-lg font-bold" data-translate-key="total_sum">ì´ í•©ê³„</span>
             <div class="flex items-center gap-2">
                <span id="total-amount-display" class="text-2xl font-bold">â‚© 0</span>
                <button id="copy-total-button" aria-label="Copy total amount" class="p-2 rounded-full hover:bg-blue-500 active:bg-blue-700">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
            </div>
        </div>
        <button id="reset-button" class="w-full mt-3 bg-white text-blue-600 font-bold py-2 rounded-lg hover:bg-gray-100 transition" data-translate-key="reset_button">ëª¨ë“  ì…ë ¥ ì´ˆê¸°í™”</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM ìš”ì†Œ ---
    const { mainContent, currencyListContainer, lastUpdated, baseRateDisplay, loader, calculator, errorMessage, retryButton, totalSummaryFooter, totalAmountDisplay, resetButton, modeExpenseBtn, modeConverterBtn, modeTip, languageSelector, copyTotalButton } = {
        mainContent: document.getElementById('main-content'), currencyListContainer: document.getElementById('currency-list'), lastUpdated: document.getElementById('last-updated'), baseRateDisplay: document.getElementById('base-rate-display'), loader: document.getElementById('loader'), calculator: document.getElementById('calculator'), errorMessage: document.getElementById('error-message'), retryButton: document.getElementById('retry-button'), totalSummaryFooter: document.getElementById('total-summary-footer'), totalAmountDisplay: document.getElementById('total-amount-display'), resetButton: document.getElementById('reset-button'), modeExpenseBtn: document.getElementById('mode-expense'), modeConverterBtn: document.getElementById('mode-converter'), modeTip: document.getElementById('mode-tip'), languageSelector: document.getElementById('language-selector'), copyTotalButton: document.getElementById('copy-total-button'),
    };

    // --- ìƒíƒœ ë³€ìˆ˜ ---
    let exchangeRates = {}, currentMode = 'expense', currentLang = 'ko', lastUpdateTimeUTC, currencyOrder = [], isOfflineMode = false;

    // --- ë°ì´í„° (ë²ˆì—­, í†µí™”) ---
    const translations = {
        ko: { title: "í™˜ìœ¨ ê³„ì‚°ê¸°", loading: "í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", last_updated: "ìµœì¢… ì—…ë°ì´íŠ¸:", mode_expense: "ê²½ë¹„ í•©ì‚°", mode_converter: "í™˜ìœ¨ ë³€í™˜", tip_expense: "ğŸ’¡ ì‚¬ìš©ë²•: ë§¨ ìœ„ í†µí™”ê°€ í•©ê³„ ê¸°ì¤€ì…ë‹ˆë‹¤. ì†ì¡ì´(â˜°)ë¥¼ ëŒì–´ ìˆœì„œë¥¼ ë°”ê¾¸ê³ , `10+10-10%`ì²˜ëŸ¼ ê³„ì‚°ì‹ì„ ì…ë ¥í•˜ì„¸ìš”!", tip_converter: "ğŸ’¡ íŒ: í•œ í†µí™”ì— ê°’ì„ ì…ë ¥í•˜ë©´ ë‚˜ë¨¸ì§€ê°€ ëª¨ë‘ ë³€í™˜ë©ë‹ˆë‹¤.", error_message: "í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", retry_button: "ë‹¤ì‹œ ì‹œë„", total_sum: "ì´ í•©ê³„", reset_button: "ëª¨ë“  ì…ë ¥ ì´ˆê¸°í™”", offline_mode: "ì˜¤í”„ë¼ì¸ ëª¨ë“œ", blog_link: "ë¸”ë¡œê·¸ ë°©ë¬¸í•˜ê¸°", copied: "ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", currency_name_krw:"ëŒ€í•œë¯¼êµ­", currency_pronunciation_krw:"ì›", currency_name_jpy:"ì¼ë³¸", currency_pronunciation_jpy:"ì—”", currency_name_cny:"ì¤‘êµ­", currency_pronunciation_cny:"ìœ„ì•ˆ", currency_name_hkd:"í™ì½©", currency_pronunciation_hkd:"ë‹¬ëŸ¬", currency_name_sgd:"ì‹±ê°€í¬ë¥´", currency_pronunciation_sgd:"ë‹¬ëŸ¬", currency_name_thb:"íƒœêµ­", currency_pronunciation_thb:"ë°”íŠ¸", currency_name_vnd:"ë² íŠ¸ë‚¨", currency_pronunciation_vnd:"ë™", currency_name_idr:"ì¸ë„ë„¤ì‹œì•„", currency_pronunciation_idr:"ë£¨í”¼ì•„", currency_name_php:"í•„ë¦¬í•€", currency_pronunciation_php:"í˜ì†Œ", currency_name_myr:"ë§ë ˆì´ì‹œì•„", currency_pronunciation_myr:"ë§ê¹ƒ", currency_name_inr:"ì¸ë„", currency_pronunciation_inr:"ë£¨í”¼", currency_name_khr:"ìº„ë³´ë””ì•„", currency_pronunciation_khr:"ë¦¬ì—˜", currency_name_lak:"ë¼ì˜¤ìŠ¤", currency_pronunciation_lak:"í‚µ", currency_name_usd:"ë¯¸êµ­", currency_pronunciation_usd:"ë‹¬ëŸ¬", currency_name_cad:"ìºë‚˜ë‹¤", currency_pronunciation_cad:"ë‹¬ëŸ¬", currency_name_mxn:"ë©•ì‹œì½”", currency_pronunciation_mxn:"í˜ì†Œ", currency_name_brl:"ë¸Œë¼ì§ˆ", currency_pronunciation_brl:"í—¤ì•Œ", currency_name_ars:"ì•„ë¥´í—¨í‹°ë‚˜", currency_pronunciation_ars:"í˜ì†Œ", currency_name_clp:"ì¹ ë ˆ", currency_pronunciation_clp:"í˜ì†Œ", currency_name_cop:"ì½œë¡¬ë¹„ì•„", currency_pronunciation_cop:"í˜ì†Œ", currency_name_pen:"í˜ë£¨", currency_pronunciation_pen:"ì†”", currency_name_eur:"ìœ ëŸ½", currency_pronunciation_eur:"ìœ ë¡œ", currency_name_gbp:"ì˜êµ­", currency_pronunciation_gbp:"íŒŒìš´ë“œ", currency_name_chf:"ìŠ¤ìœ„ìŠ¤", currency_pronunciation_chf:"í”„ë‘", currency_name_try:"í„°í‚¤", currency_pronunciation_try:"ë¦¬ë¼", currency_name_pln:"í´ë€ë“œ", currency_pronunciation_pln:"ì¦ˆì›Œí‹°", currency_name_czk:"ì²´ì½”", currency_pronunciation_czk:"ì½”ë£¨ë‚˜", currency_name_huf:"í—ê°€ë¦¬", currency_pronunciation_huf:"í¬ë¦°íŠ¸", currency_name_bam:"ë³´ìŠ¤ë‹ˆì•„", currency_pronunciation_bam:"ë§ˆë¥´ì¹´", currency_name_rsd:"ì„¸ë¥´ë¹„ì•„", currency_pronunciation_rsd:"ë””ë‚˜ë¥´", currency_name_mkd:"ë¶ë§ˆì¼€ë„ë‹ˆì•„", currency_pronunciation_mkd:"ë°ë‚˜ë¥´", currency_name_all:"ì•Œë°”ë‹ˆì•„", currency_pronunciation_all:"ë ‰", currency_name_bgn:"ë¶ˆê°€ë¦¬ì•„", currency_pronunciation_bgn:"ë ˆí”„", currency_name_ron:"ë£¨ë§ˆë‹ˆì•„", currency_pronunciation_ron:"ë ˆìš°", currency_name_mdl:"ëª°ë„ë°”", currency_pronunciation_mdl:"ë ˆìš°", currency_name_gel:"ì¡°ì§€ì•„", currency_pronunciation_gel:"ë¼ë¦¬", currency_name_nok:"ë…¸ë¥´ì›¨ì´", currency_pronunciation_nok:"í¬ë¡œë„¤", currency_name_sek:"ìŠ¤ì›¨ë´", currency_pronunciation_sek:"í¬ë¡œë‚˜", currency_name_dkk:"ë´ë§ˆí¬", currency_pronunciation_dkk:"í¬ë¡œë„¤", currency_name_aud:"í˜¸ì£¼", currency_pronunciation_aud:"ë‹¬ëŸ¬", currency_name_nzd:"ë‰´ì§ˆëœë“œ", currency_pronunciation_nzd:"ë‹¬ëŸ¬", currency_name_aed:"UAE", currency_pronunciation_aed:"ë””ë¥´í•¨", currency_name_ils:"ì´ìŠ¤ë¼ì—˜", currency_pronunciation_ils:"ì…°ì¼ˆ", currency_name_egp:"ì´ì§‘íŠ¸", currency_pronunciation_egp:"íŒŒìš´ë“œ", currency_name_zar:"ë‚¨ì•„ê³µ", currency_pronunciation_zar:"ëœë“œ" },
        en: { title: "Currency Converter", loading: "Loading rates...", last_updated: "Last Updated:", mode_expense: "Expense Sum", mode_converter: "Converter", tip_expense: "ğŸ’¡ How to use: The top currency is the sum's base. Drag the handle (â˜°) to reorder and enter calculations like `10+10-10%`!", tip_converter: "ğŸ’¡ Tip: Enter a value in one currency to convert all others.", error_message: "Failed to load exchange rates. Please try again later.", retry_button: "Try Again", total_sum: "Total Sum", reset_button: "Reset All Inputs", offline_mode: "Offline Mode", blog_link: "Visit my blog", copied: "Copied!", currency_name_krw:"South Korea", currency_pronunciation_krw:"Won", currency_name_jpy:"Japan", currency_pronunciation_jpy:"Yen", currency_name_cny:"China", currency_pronunciation_cny:"Yuan", currency_name_hkd:"Hong Kong", currency_pronunciation_hkd:"Dollar", currency_name_sgd:"Singapore", currency_pronunciation_sgd:"Dollar", currency_name_thb:"Thailand", currency_pronunciation_thb:"Baht", currency_name_vnd:"Vietnam", currency_pronunciation_vnd:"Dong", currency_name_idr:"Indonesia", currency_pronunciation_idr:"Rupiah", currency_name_php:"Philippines", currency_pronunciation_php:"Peso", currency_name_myr:"Malaysia", currency_pronunciation_myr:"Ringgit", currency_name_inr:"India", currency_pronunciation_inr:"Rupee", currency_name_khr:"Cambodia", currency_pronunciation_khr:"Riel", currency_name_lak:"Laos", currency_pronunciation_lak:"Kip", currency_name_usd:"United States", currency_pronunciation_usd:"Dollar", currency_name_cad:"Canada", currency_pronunciation_cad:"Dollar", currency_name_mxn:"Mexico", currency_pronunciation_mxn:"Peso", currency_name_brl:"Brazil", currency_pronunciation_brl:"Real", currency_name_ars:"Argentina", currency_pronunciation_ars:"Peso", currency_name_clp:"Chile", currency_pronunciation_clp:"Peso", currency_name_cop:"Colombia", currency_pronunciation_cop:"Peso", currency_name_pen:"Peru", currency_pronunciation_pen:"Sol", currency_name_eur:"Europe", currency_pronunciation_eur:"Euro", currency_name_gbp:"United Kingdom", currency_pronunciation_gbp:"Pound", currency_name_chf:"Switzerland", currency_pronunciation_chf:"Franc", currency_name_try:"Turkey", currency_pronunciation_try:"Lira", currency_name_pln:"Poland", currency_pronunciation_pln:"ZÅ‚oty", currency_name_czk:"Czech Republic", currency_pronunciation_czk:"Koruna", currency_name_huf:"Hungary", currency_pronunciation_huf:"Forint", currency_name_bam:"Bosnia", currency_pronunciation_bam:"Mark", currency_name_rsd:"Serbia", currency_pronunciation_rsd:"Dinar", currency_name_mkd:"North Macedonia", currency_pronunciation_mkd:"Denar", currency_name_all:"Albania", currency_pronunciation_all:"Lek", currency_name_bgn:"Bulgaria", currency_pronunciation_bgn:"Lev", currency_name_ron:"Romania", currency_pronunciation_ron:"Leu", currency_name_mdl:"Moldova", currency_pronunciation_mdl:"Leu", currency_name_gel:"Georgia", currency_pronunciation_gel:"Lari", currency_name_nok:"Norway", currency_pronunciation_nok:"Krone", currency_name_sek:"Sweden", currency_pronunciation_sek:"Krona", currency_name_dkk:"Denmark", currency_pronunciation_dkk:"Krone", currency_name_aud:"Australia", currency_pronunciation_aud:"Dollar", currency_name_nzd:"New Zealand", currency_pronunciation_nzd:"Dollar", currency_name_aed:"UAE", currency_pronunciation_aed:"Dirham", currency_name_ils:"Israel", currency_pronunciation_ils:"Shekel", currency_name_egp:"Egypt", currency_pronunciation_egp:"Pound", currency_name_zar:"South Africa", currency_pronunciation_zar:"Rand" },
    };
    const targetCurrencies = { 'KRW': { country: 'kr', name: 'ëŒ€í•œë¯¼êµ­ ì›', symbol: 'â‚©' }, 'JPY': { country: 'jp', name: 'ì¼ë³¸ ì—”', symbol: 'Â¥' }, 'CNY': { country: 'cn', name: 'ì¤‘êµ­ ìœ„ì•ˆ', symbol: 'Â¥' }, 'HKD': { country: 'hk', name: 'í™ì½© ë‹¬ëŸ¬', symbol: '$' }, 'SGD': { country: 'sg', name: 'ì‹±ê°€í¬ë¥´ ë‹¬ëŸ¬', symbol: '$' }, 'THB': { country: 'th', name: 'íƒœêµ­ ë°”íŠ¸', symbol: 'à¸¿' }, 'VND': { country: 'vn', name: 'ë² íŠ¸ë‚¨ ë™', symbol: 'â‚«' }, 'IDR': { country: 'id', name: 'ì¸ë„ë„¤ì‹œì•„ ë£¨í”¼ì•„', symbol: 'Rp' }, 'PHP': { country: 'ph', name: 'í•„ë¦¬í•€ í˜ì†Œ', symbol: 'â‚±' }, 'MYR': { country: 'my', name: 'ë§ë ˆì´ì‹œì•„ ë§ê¹ƒ', symbol: 'RM' }, 'INR': { country: 'in', name: 'ì¸ë„ ë£¨í”¼', symbol: 'â‚¹' }, 'KHR': { country: 'kh', name: 'ìº„ë³´ë””ì•„ ë¦¬ì—˜', symbol: 'áŸ›' }, 'LAK': { country: 'la', name: 'ë¼ì˜¤ìŠ¤ í‚µ', symbol: 'â‚­' }, 'USD': { country: 'us', name: 'ë¯¸êµ­ ë‹¬ëŸ¬', symbol: '$' }, 'CAD': { country: 'ca', name: 'ìºë‚˜ë‹¤ ë‹¬ëŸ¬', symbol: '$' }, 'MXN': { country: 'mx', name: 'ë©•ì‹œì½” í˜ì†Œ', symbol: '$' }, 'BRL': { country: 'br', name: 'ë¸Œë¼ì§ˆ í—¤ì•Œ', symbol: 'R$' }, 'ARS': { country: 'ar', name: 'ì•„ë¥´í—¨í‹°ë‚˜ í˜ì†Œ', symbol: '$' }, 'CLP': { country: 'cl', name: 'ì¹ ë ˆ í˜ì†Œ', symbol: '$' }, 'COP': { country: 'co', name: 'ì½œë¡¬ë¹„ì•„ í˜ì†Œ', symbol: '$' }, 'PEN': { country: 'pe', name: 'í˜ë£¨ ì†”', symbol: 'S/.' }, 'EUR': { country: 'eu', name: 'ìœ ëŸ½ ìœ ë¡œ', symbol: 'â‚¬' }, 'GBP': { country: 'gb', name: 'ì˜êµ­ íŒŒìš´ë“œ', symbol: 'Â£' }, 'CHF': { country: 'ch', name: 'ìŠ¤ìœ„ìŠ¤ í”„ë‘', symbol: 'Fr' }, 'TRY': { country: 'tr', name: 'í„°í‚¤ ë¦¬ë¼', symbol: 'â‚º' }, 'PLN': { country: 'pl', name: 'í´ë€ë“œ ì¦ˆì›Œí‹°', symbol: 'zÅ‚' }, 'CZK': { country: 'cz', name: 'ì²´ì½” ì½”ë£¨ë‚˜', symbol: 'KÄ' }, 'HUF': { country: 'hu', name: 'í—ê°€ë¦¬ í¬ë¦°íŠ¸', symbol: 'Ft' }, 'BAM': { country: 'ba', name: 'ë³´ìŠ¤ë‹ˆì•„ ë§ˆë¥´ì¹´', symbol: 'KM' }, 'RSD': { country: 'rs', name: 'ì„¸ë¥´ë¹„ì•„ ë””ë‚˜ë¥´', symbol: 'din' }, 'MKD': { country: 'mk', name: 'ë¶ë§ˆì¼€ë„ë‹ˆì•„ ë°ë‚˜ë¥´', symbol: 'Ğ´ĞµĞ½' }, 'ALL': { country: 'al', name: 'ì•Œë°”ë‹ˆì•„ ë ‰', symbol: 'L' }, 'BGN': { country: 'bg', name: 'ë¶ˆê°€ë¦¬ì•„ ë ˆí”„', symbol: 'Ğ»Ğ²' }, 'RON': { country: 'ro', name: 'ë£¨ë§ˆë‹ˆì•„ ë ˆìš°', symbol: 'lei' }, 'MDL': { country: 'md', name: 'ëª°ë„ë°” ë ˆìš°', symbol: 'L' }, 'GEL': { country: 'ge', name: 'ì¡°ì§€ì•„ ë¼ë¦¬', symbol: 'â‚¾' }, 'NOK': { country: 'no', name: 'ë…¸ë¥´ì›¨ì´ í¬ë¡œë„¤', symbol: 'kr' }, 'SEK': { country: 'se', name: 'ìŠ¤ì›¨ë´ í¬ë¡œë‚˜', symbol: 'kr' }, 'DKK': { country: 'dk', name: 'ë´ë§ˆí¬ í¬ë¡œë„¤', symbol: 'kr' }, 'AUD': { country: 'au', name: 'í˜¸ì£¼ ë‹¬ëŸ¬', symbol: '$' }, 'NZD': { country: 'nz', name: 'ë‰´ì§ˆëœë“œ ë‹¬ëŸ¬', symbol: '$' }, 'AED': { country: 'ae', name: 'UAE ë””ë¥´í•¨', symbol: 'Ø¯.Ø¥' }, 'ILS': { country: 'il', name: 'ì´ìŠ¤ë¼ì—˜ ì…°ì¼ˆ', symbol: 'â‚ª' }, 'EGP': { country: 'eg', name: 'ì´ì§‘íŠ¸ íŒŒìš´ë“œ', symbol: 'EÂ£' }, 'ZAR': { country: 'za', name: 'ë‚¨ì•„ê³µ ëœë“œ', symbol: 'R' }, };

    initializeApp();

    function initializeApp() {
        registerStaticEventListeners();
        loadCurrencyOrder();
        fetchRates();
    }

    function registerStaticEventListeners() {
        window.addEventListener('online', fetchRates);
        languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
        retryButton.addEventListener('click', fetchRates);
        modeExpenseBtn.addEventListener('click', () => setMode('expense'));
        modeConverterBtn.addEventListener('click', () => setMode('converter'));
        resetButton.addEventListener('click', resetAllInputs);
        copyTotalButton.addEventListener('click', copyTotalToClipboard);
    }

    function getSafeLocalStorage(key, defaultValue) {
        try { const value = localStorage.getItem(key); return value !== null ? JSON.parse(value) : defaultValue; } 
        catch (e) { return defaultValue; }
    }

    function setSafeLocalStorage(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); } 
        catch (e) { console.warn("localStorage ì €ì¥ ì‹¤íŒ¨:", e); }
    }

    function loadCurrencyOrder() {
        const savedOrder = getSafeLocalStorage('currencyOrder', null);
        currencyOrder = (savedOrder && Array.isArray(savedOrder) && savedOrder.every(code => targetCurrencies[code])) ? savedOrder : Object.keys(targetCurrencies);
    }

    async function fetchRates(retryCount = 3, delay = 1000) {
        showLoader();
        for (let i = 0; i < retryCount; i++) {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                if (!response.ok) throw new Error(`Network error: ${response.status}`);
                const data = await response.json();
                if (data.result !== 'success') throw new Error('API returned an error');
                onRatesLoaded(data, false);
                return;
            } catch (error) {
                if (i === retryCount - 1) {
                    const cachedData = getSafeLocalStorage('cachedRates', null);
                    if (cachedData) onRatesLoaded(cachedData, true);
                    else showError();
                } else {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
    }
    
    function onRatesLoaded(data, isOffline) {
        exchangeRates = data.rates;
        lastUpdateTimeUTC = data.time_last_update_utc;
        isOfflineMode = isOffline;
        if (!isOffline) setSafeLocalStorage('cachedRates', data);

        const savedLang = getSafeLocalStorage('preferredLanguage', 'ko');
        setLanguage(savedLang, true);
        setMode(getSafeLocalStorage('preferredMode', 'expense'), true);
        showCalculator();
    }

    function setMode(newMode, isInitialLoad = false) {
        currentMode = newMode;
        setSafeLocalStorage('preferredMode', newMode);
        if (!isInitialLoad) document.querySelectorAll('.currency-input').forEach(input => input.value = '');
        buildCalculatorUI();
        applyTranslations();
    }
    
    function setLanguage(lang, isInitialLoad = false) {
        currentLang = lang;
        if (!isInitialLoad) setSafeLocalStorage('preferredLanguage', lang);
        languageSelector.value = lang;
        document.documentElement.lang = lang;
        document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
        if (!isInitialLoad) applyTranslations();
    }

    function buildCalculatorUI() {
        currencyListContainer.innerHTML = '';
        currencyOrder.forEach(code => currencyListContainer.appendChild(createCurrencyCard(code)));
        registerDynamicEventListeners();
    }

    function createCurrencyCard(code) {
        const currency = targetCurrencies[code];
        const card = document.createElement('div');
        card.className = `currency-item flex items-center gap-3 p-3 bg-gray-50 rounded-xl border-2 border-transparent transition-shadow duration-300`;
        const inputElement = currentMode === 'expense'
            ? `<textarea class="autoresize-textarea currency-input w-full bg-white text-right font-semibold text-lg text-gray-800 rounded-md py-2 pl-8 pr-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-currency-code="${code}" placeholder="0" rows="1" aria-label="${currency.name} ì…ë ¥"></textarea>`
            : `<input type="text" inputmode="decimal" class="currency-input w-full bg-white text-right font-semibold text-lg text-gray-800 rounded-md py-2 pl-8 pr-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-currency-code="${code}" placeholder="0.00" aria-label="${currency.name} ì…ë ¥">`;
        card.innerHTML = `<div class="drag-handle p-2" role="button" tabindex="0"><svg class="w-6 h-6 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div><div class="flex flex-col items-center w-14 text-center"><img src="https://flagcdn.com/w40/${currency.country}.png" alt="${code}" class="w-10 h-10 rounded-full shadow-sm" onerror="this.style.display='none'"><p class="text-xs text-gray-500 mt-1 w-full truncate" data-translate-key="currency_name_${code.toLowerCase()}"></p></div><div class="flex-grow"><p class="font-bold text-gray-800">${code}</p><p class="text-xs text-gray-500" data-translate-key="currency_pronunciation_${code.toLowerCase()}"></p></div><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg">${currency.symbol}</span>${inputElement}</div>`;
        return card;
    }
    
    function applyTranslations() {
        const lang = currentLang;
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            el.textContent = translations[lang]?.[key] ?? translations['en']?.[key] ?? (el.dataset.translateKey.startsWith('currency_') ? '' : key);
        });
        if (lastUpdateTimeUTC) {
            const updateDate = new Date(lastUpdateTimeUTC);
            const prefix = translations[lang]?.last_updated ?? 'Last Updated:';
            lastUpdated.innerHTML = `${prefix} ${updateDate.toLocaleString(lang)}`;
            if (isOfflineMode) lastUpdated.innerHTML += ` <span class="offline-indicator">${translations[lang]?.offline_mode ?? 'Offline Mode'}</span>`;
        }
        updateBaseRateDisplay();
        updateModeUI();
    }

    function updateModeUI() {
        const isExpenseMode = currentMode === 'expense';
        modeExpenseBtn.classList.toggle('active', isExpenseMode);
        modeConverterBtn.classList.toggle('active', !isExpenseMode);
        modeExpenseBtn.setAttribute('aria-pressed', isExpenseMode);
        modeConverterBtn.setAttribute('aria-pressed', !isExpenseMode);
        totalSummaryFooter.classList.toggle('hidden', !isExpenseMode);
        mainContent.style.paddingBottom = isExpenseMode ? '8rem' : '2rem';
        modeTip.dataset.translateKey = isExpenseMode ? 'tip_expense' : 'tip_converter';
        modeTip.textContent = translations[currentLang]?.[modeTip.dataset.translateKey] ?? '';
        updateTotalAmount();
    }

    function registerDynamicEventListeners() {
        document.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('input', currentMode === 'expense' ? handleExpenseInput : handleConverterInput);
        });
        addDragDropListeners();
    }
    
    function handleExpenseInput(e) { autoResizeTextarea(e.target); updateTotalAmount(); }
    
    function handleConverterInput(e) {
        const sourceInput = e.target;
        const sourceValue = parseFloat(sourceInput.value.replace(/,/g, ''));
        if (isNaN(sourceValue) || sourceValue === 0) {
            document.querySelectorAll('.currency-input').forEach(i => { if (i !== sourceInput) i.value = ''; });
            return;
        }
        const sourceValueInUSD = sourceValue / exchangeRates[sourceInput.dataset.currencyCode];
        document.querySelectorAll('.currency-input').forEach(input => {
            if (input !== sourceInput) {
                const targetValue = sourceValueInUSD * exchangeRates[input.dataset.currencyCode];
                input.value = targetValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        });
    }

    function addDragDropListeners() {
        let draggingEl = null, autoscrollInterval = null, longPressTimer = null;
        let placeholder = document.createElement('div');
        placeholder.className = 'drop-placeholder';

        currencyListContainer.addEventListener('pointerdown', e => {
            const handle = e.target.closest('.drag-handle');
            if (!handle || e.button !== 0) return;
            
            if (e.pointerType === 'touch') {
                longPressTimer = setTimeout(() => {
                    e.preventDefault();
                    startDrag(handle.closest('.currency-item'));
                }, 200);
            } else {
                e.preventDefault();
                startDrag(handle.closest('.currency-item'));
            }
        });

        currencyListContainer.addEventListener('pointerup', () => clearTimeout(longPressTimer));
        currencyListContainer.addEventListener('pointercancel', () => clearTimeout(longPressTimer));

        currencyListContainer.addEventListener('keydown', e => {
            if (e.key !== 'Enter' && e.key !== ' ') return;
            const handle = e.target.closest('.drag-handle');
            if (!handle) return;
            e.preventDefault();
            const item = handle.closest('.currency-item');
            const sibling = e.shiftKey ? item.previousElementSibling : item.nextElementSibling;
            if (sibling && sibling.matches('.currency-item')) {
                sibling.insertAdjacentElement(e.shiftKey ? 'beforebegin' : 'afterend', item);
                handle.focus();
                saveOrderAndRefresh();
            }
        });

        function startDrag(el) {
            draggingEl = el;
            draggingEl.classList.add('dragging');
            draggingEl.after(placeholder);
            document.body.classList.add('is-dragging');
            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp, { once: true });
        }

        function onPointerMove(e) {
            if (!draggingEl) return;
            const afterElement = getDragAfterElement(currencyListContainer, e.clientY);
            currencyListContainer.insertBefore(placeholder, afterElement);
            handleAutoscroll(e.clientY);
        }

        function onPointerUp() {
            if (!draggingEl) return;
            clearTimeout(longPressTimer);
            document.removeEventListener('pointermove', onPointerMove);
            clearInterval(autoscrollInterval);
            autoscrollInterval = null;
            
            placeholder.replaceWith(draggingEl);
            draggingEl.classList.remove('dragging');
            document.body.classList.remove('is-dragging');
            draggingEl = null;
            saveOrderAndRefresh();
        }
        
        function handleAutoscroll(clientY) {
            clearInterval(autoscrollInterval);
            const scrollThreshold = 80;
            if (clientY < scrollThreshold) {
                autoscrollInterval = setInterval(() => window.scrollBy(0, -10), 16);
            } else if (clientY > window.innerHeight - scrollThreshold) {
                autoscrollInterval = setInterval(() => window.scrollBy(0, 10), 16);
            }
        }
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.currency-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function saveOrderAndRefresh() {
        currencyOrder = Array.from(currencyListContainer.querySelectorAll('.currency-input')).map(input => input.dataset.currencyCode);
        setSafeLocalStorage('currencyOrder', currencyOrder);
        updateBaseRateDisplay();
        updateTotalAmount();
    }
    
    function evaluateExpression(str) {
        if (!str || !str.trim()) return 0;
        try {
            const sanitized = str.replace(/[^-()\d/*+%.]/g, '').replace(/(\d*\.?\d+)%/g, '($1/100)');
            return Function('"use strict";return (' + sanitized + ')')();
        } catch { return 0; }
    }
    
    function updateBaseRateDisplay() {
        const baseCode = currencyOrder[0];
        const quoteCode = baseCode === 'USD' ? 'KRW' : 'USD';
        if (!exchangeRates[baseCode] || !exchangeRates[quoteCode]) return;
        const rate = exchangeRates[quoteCode] / exchangeRates[baseCode];
        baseRateDisplay.textContent = `1 ${baseCode} = ${rate.toFixed(4)} ${quoteCode}`;
    }

    function updateTotalAmount() {
        if (currentMode !== 'expense') return;
        const baseCode = currencyOrder[0];
        let totalUSD = 0;
        document.querySelectorAll('.currency-input').forEach(input => {
            const value = evaluateExpression(input.value);
            if (value && exchangeRates[input.dataset.currencyCode]) {
                totalUSD += value / exchangeRates[input.dataset.currencyCode];
            }
        });
        const totalInBase = totalUSD * (exchangeRates[baseCode] || 0);
        totalAmountDisplay.textContent = `${targetCurrencies[baseCode].symbol} ${totalInBase.toLocaleString('ko-KR', {maximumFractionDigits: 0})}`;
    }

    function resetAllInputs() {
        document.querySelectorAll('.currency-input').forEach(input => { input.value = ''; autoResizeTextarea(input); });
        updateTotalAmount();
    }
    
    function autoResizeTextarea(textarea) {
        if (textarea?.tagName?.toLowerCase() === 'textarea') { textarea.style.height = 'auto'; textarea.style.height = `${textarea.scrollHeight}px`; }
    }
    
    function copyTotalToClipboard() {
        const textToCopy = totalAmountDisplay.textContent;
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy.replace(/[^0-9.]/g, ''); // ìˆ«ìë§Œ ë³µì‚¬
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showCopyFeedback();
        } catch (err) {
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
        }
        document.body.removeChild(textArea);
    }
    
    function showCopyFeedback() {
        let feedback = document.querySelector('.copy-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'copy-feedback';
            document.body.appendChild(feedback);
        }
        feedback.textContent = translations[currentLang]?.copied ?? 'Copied!';
        feedback.style.opacity = 1;
        setTimeout(() => {
            feedback.style.opacity = 0;
        }, 2000);
    }

    function showLoader() { loader.classList.remove('hidden'); calculator.classList.add('hidden'); errorMessage.classList.add('hidden'); }
    function showCalculator() { loader.classList.add('hidden'); calculator.classList.remove('hidden'); errorMessage.classList.add('hidden'); }
    function showError() { loader.classList.add('hidden'); calculator.classList.add('hidden'); errorMessage.classList.remove('hidden'); }
});
</script>
</body>
</html>

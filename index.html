<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="환율 계산기">

    <link rel="apple-touch-icon" href="https://i.ibb.co/mRpP36p/currency-icon.png">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
            crossorigin="anonymous"></script>

    <title>환율 계산기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Cairo:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Noto Sans JP', 'Cairo', sans-serif;
            background-color: #f0f2f5;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 드래그 앤 드롭 스타일 */
        .currency-item {
            transition: box-shadow 0.2s ease-in-out;
        }
        .drag-handle {
            cursor: grab;
            touch-action: none;
        }
        .dragging {
            opacity: 0.8;
            background: #e0e7ff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        body.is-dragging {
            user-select: none; /* 드래그 중 텍스트 선택 방지 */
        }
        /* 자동 높이 조절 textarea */
        .autoresize-textarea {
            resize: none;
            overflow: hidden;
            min-height: 44px; /* 초기 높이 */
        }
        /* 모드 버튼 스타일 */
        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mode-btn {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        /* 상단 고정 스타일 (모든 모드) */
        #currency-list > .currency-item:first-child {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        /* 광고 컨테이너 스타일 */
        .ad-container {
            min-height: 100px; /* 광고 로딩 전 최소 높이 */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            color: #9ca3af;
            font-size: 0.875rem;
            text-align: center;
            margin: 1rem 0;
            width: 100%;
        }
        /* 오프라인 모드 표시 */
        .offline-indicator {
            background-color: #fef2f2;
            color: #b91c1c;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        /* 블로그 링크 스타일 */
        .blog-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: #3b82f6;
            text-decoration: underline;
            font-size: 0.875rem;
        }
        .blog-link:hover {
            color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen"> <div class="w-full h-full max-w-lg mx-auto bg-white rounded-none sm:rounded-2xl shadow-none sm:shadow-xl">
    <div id="main-content" class="p-6 md:p-8 pb-32"> <div class="relative text-center mb-4 pt-4">
            <h1 id="app-title" class="text-3xl font-bold text-gray-800" data-translate-key="title">환율 계산기</h1>
            <div id="rate-info" class="text-sm text-gray-600 my-3">
                <p id="base-rate-display">1 USD = 0.00 KRW</p>
                <div class="flex justify-center items-center gap-2 mt-1">
                    <p id="last-updated" data-translate-key="last_updated">최종 업데이트: -</p>
                    <div dir="ltr">
                        <select id="language-selector" class="bg-gray-100 border border-gray-300 rounded-md p-1 text-xs focus:ring-blue-500 focus:border-blue-500">
                            <option value="ko">한국어</option>
                            <option value="en">English</option>
                            <option value="ja">日本語</option>
                            <option value="zh">简体中文</option>
                            <option value="es">Español</option>
                            <option value="fr">Français</option>
                            <option value="de">Deutsch</option>
                            <option value="ar">العربية</option>
                            <option value="ru">Русский</option>
                            <option value="ka">ქართული</option>
                            <option value="vi">Tiếng Việt</option>
                            <option value="th">ไทย</option>
                            <option value="km">ខ្មែរ</option>
                            <option value="pt">Português</option>
                        </select>
                    </div>
                </div>
                <a href="https://blog.naver.com/nohassle" target="_blank" class="blog-link" data-translate-key="blog_link">블로그 방문하기</a>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-200 rounded-lg mb-4">
            <button id="mode-expense" class="mode-btn font-bold py-2 rounded-md transition-colors" data-translate-key="mode_expense" aria-pressed="true">경비 합산</button>
            <button id="mode-converter" class="mode-btn font-bold py-2 rounded-md transition-colors" data-translate-key="mode_converter" aria-pressed="false">환율 변환</button>
        </div>
        <p id="mode-tip" class="text-xs text-center text-blue-600 bg-blue-50 p-2 rounded-lg mb-4" data-translate-key="tip_expense">
            💡 팁: 입력창에 `100+50*95%` 처럼 계산할 수 있어요!
        </p>

        <div id="loader" class="flex justify-center items-center h-60">
            <div class="loader"></div>
        </div>

        <div id="calculator" class="hidden">
            <div id="currency-list" class="space-y-4">
                </div>
        </div>

        <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-700 rounded-lg">
            <p data-translate-key="error_message">환율 정보를 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.</p>
            <button id="retry-button" class="mt-3 bg-red-700 text-white px-4 py-2 rounded-md text-sm hover:bg-red-800 transition-colors" data-translate-key="retry_button">다시 시도</button>
        </div>
    </div>

    <div id="total-summary-footer" class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-blue-600 text-white p-4 shadow-lg rounded-t-2xl hidden">
        <div class="flex justify-between items-center">
            <span class="text-lg font-bold" data-translate-key="total_sum">총 합계</span>
            <span id="total-amount-display" class="text-2xl font-bold">₩ 0</span>
        </div>
        <button id="reset-button" class="w-full mt-3 bg-white text-blue-600 font-bold py-2 rounded-lg hover:bg-gray-100 transition" data-translate-key="reset_button">모든 입력 초기화</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --------- DOM 요소 선택 ---------
        const mainContent = document.getElementById('main-content');
        const currencyListContainer = document.getElementById('currency-list');
        const lastUpdated = document.getElementById('last-updated');
        const baseRateDisplay = document.getElementById('base-rate-display');
        const loader = document.getElementById('loader');
        const calculator = document.getElementById('calculator');
        const errorMessage = document.getElementById('error-message');
        const retryButton = document.getElementById('retry-button');
        const totalSummaryFooter = document.getElementById('total-summary-footer');
        const totalAmountDisplay = document.getElementById('total-amount-display');
        const resetButton = document.getElementById('reset-button');
        const modeExpenseBtn = document.getElementById('mode-expense');
        const modeConverterBtn = document.getElementById('mode-converter');
        const modeTip = document.getElementById('mode-tip');
        const languageSelector = document.getElementById('language-selector');

        // --------- 상태 변수 ---------
        let exchangeRates = {};
        let currentMode = 'expense';
        let currentLang = 'ko';
        let lastUpdateTimeUTC;
        let currencyOrder = [];
        let isOfflineMode = false;

        // --------- 다국어 지원 ---------
        const translations = {
            ko: {
                title: "환율 계산기",
                last_updated: "최종 업데이트:",
                mode_expense: "경비 합산",
                mode_converter: "환율 변환",
                tip_expense: "💡 사용법: 맨 위 통화가 합계 기준입니다. 손잡이(☰)를 끌어 순서를 바꾸고, `10+10-10%`처럼 계산식을 입력하세요!",
                tip_converter: "💡 팁: 한 통화에 값을 입력하면 나머지가 모두 변환됩니다.",
                error_message: "환율 정보를 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.",
                retry_button: "다시 시도",
                total_sum: "총 합계",
                reset_button: "모든 입력 초기화",
                offline_mode: "오프라인 모드",
                blog_link: "블로그 방문하기",
                currency_name_krw: "대한민국 원",
                currency_name_usd: "미국 달러",
                currency_name_jpy: "일본 엔",
            },
            en: {
                title: "Currency Converter",
                last_updated: "Last Updated:",
                mode_expense: "Expense Sum",
                mode_converter: "Converter",
                tip_expense: "💡 How to use: The top currency is the sum's base. Drag the handle (☰) to reorder and enter calculations like `10+10-10%`!",
                tip_converter: "💡 Tip: Enter a value in one currency to convert all others.",
                error_message: "Failed to load exchange rates. Please try again later.",
                retry_button: "Try Again",
                total_sum: "Total Sum",
                reset_button: "Reset All Inputs",
                offline_mode: "Offline Mode",
                blog_link: "Visit my blog",
                currency_name_krw: "Korean Won",
                currency_name_usd: "US Dollar",
                currency_name_jpy: "Japanese Yen",
            },
            ja: {
                title: "為替レート計算機",
                last_updated: "最終更新:",
                mode_expense: "経費合算",
                mode_converter: "為替変換",
                tip_expense: "💡使い方: 一番上の通貨が合計の基準です。ハンドル(☰)をドラッグして順序を変え、`10+10-10%`のように計算式を入力してください！",
                tip_converter: "💡ヒント：一つの通貨に値を入力すると、他がすべて変換されます。",
                error_message: "為替レートの読み込みに失敗しました。後でもう一度お試しください。",
                retry_button: "再試行",
                total_sum: "合計",
                reset_button: "すべての入力をリセット",
                offline_mode: "オフラインモード",
                blog_link: "ブログを訪問",
                currency_name_krw: "韓国ウォン",
                currency_name_usd: "米ドル",
                currency_name_jpy: "日本円",
            },
            zh: {
                title: "汇率计算器",
                last_updated: "最后更新:",
                mode_expense: "费用合计",
                mode_converter: "汇率换算",
                tip_expense: "💡 使用方法: 最上方的货币是总计的基准。拖动把手(☰)重新排序，并像 `10+10-10%` 一样输入计算！",
                tip_converter: "💡 提示：在一个货币中输入一个值，所有其他货币都会转换。",
                error_message: "加载汇率失败。请稍后再试。",
                retry_button: "重试",
                total_sum: "总计",
                reset_button: "重置所有输入",
                offline_mode: "离线模式",
                blog_link: "访问我的博客",
                currency_name_krw: "韩元",
                currency_name_usd: "美元",
                currency_name_jpy: "日元",
            },
            // 러시아어 추가
            ru: {
                title: "Конвертер Валют",
                last_updated: "Последнее обновление:",
                mode_expense: "Сумма расходов",
                mode_converter: "Конвертер",
                tip_expense: "💡 Как использовать: Верхняя валюта является базой для суммы. Перетащите ручку (☰) для переупорядочивания и введите вычисления вроде `10+10-10%`!",
                tip_converter: "💡 Совет: Введите значение в одной валюте, чтобы преобразовать все остальные.",
                error_message: "Не удалось загрузить обменные курсы. Пожалуйста, попробуйте позже.",
                retry_button: "Повторить",
                total_sum: "Общая сумма",
                reset_button: "Сбросить все",
                offline_mode: "Автономный режим",
                blog_link: "Посетить мой блог",
                currency_name_krw: "Южнокорейская вона",
                currency_name_usd: "Доллар США",
                currency_name_jpy: "Японская иена",
            },
            // 조지아어
            ka: {
                title: "ვალუტის კონვერტერი",
                last_updated: "ბოლო განახლება:",
                mode_expense: "ხარჯების ჯამი",
                mode_converter: "კონვერტერი",
                tip_expense: "💡 როგორ გამოვიყენოთ: ზედა ვალუტა არის ჯამის საფუძველი. გადაიტანეთ სახელური (☰) რიგის შესაცვლელად და შეიყვანეთ გამოთვლები როგორც `10+10-10%`!",
                tip_converter: "💡 რჩევა: შეიყვანეთ მნიშვნელობა ერთ ვალუტაში, რომ გარდაქმნას ყველა სხვა.",
                error_message: "ვერ მოხერხდა გაცვლითი კურსების ჩატვირთვა. გთხოვთ სცადოთ მოგვიანებით.",
                retry_button: "ხელახლა ცდა",
                total_sum: "სრული ჯამი",
                reset_button: "ყველა შეყვანის გადატვირთვა",
                offline_mode: "ოფლაინ რეჟიმი",
                blog_link: "ბლოგის მონახულება",
            },
            // 베트남어
            vi: {
                title: "Máy Tính Tỷ Giá",
                last_updated: "Cập nhật lần cuối:",
                mode_expense: "Tổng Chi Phí",
                mode_converter: "Chuyển Đổi",
                tip_expense: "💡 Cách sử dụng: Tiền tệ hàng đầu là cơ sở của tổng. Kéo tay cầm (☰) để sắp xếp lại và nhập tính toán như `10+10-10%`!",
                tip_converter: "💡 Mẹo: Nhập giá trị trong một loại tiền để chuyển đổi tất cả các loại tiền khác.",
                error_message: "Không thể tải tỷ giá hối đoái. Vui lòng thử lại sau.",
                retry_button: "Thử Lại",
                total_sum: "Tổng Cộng",
                reset_button: "Đặt Lại Tất Cả",
                offline_mode: "Chế độ ngoại tuyến",
                blog_link: "Ghé thăm blog của tôi",
            },
            // 태국어
            th: {
                title: "เครื่องคิดเลขอัตราแลกเปลี่ยน",
                last_updated: "อัปเดตล่าสุด:",
                mode_expense: "รวมค่าใช้จ่าย",
                mode_converter: "ตัวแปลง",
                tip_expense: "💡 วิธีใช้: สกุลเงินด้านบนเป็นฐานของผลรวม ลากที่จับ (☰) เพื่อจัดเรียงใหม่และป้อนการคำนวณเช่น `10+10-10%`!",
                tip_converter: "💡 เคล็ดลับ: ป้อนค่าในสกุลเงินหนึ่งเพื่อแปลงทั้งหมด",
                error_message: "ไม่สามารถโหลดอัตราแลกเปลี่ยนได้ โปรดลองอีกครั้งในภายหลัง",
                retry_button: "ลองอีกครั้ง",
                total_sum: "ยอดรวมทั้งหมด",
                reset_button: "รีเซ็ตทั้งหมด",
                offline_mode: "โหมดออฟไลน์",
                blog_link: "เยี่ยมชมบล็อกของฉัน",
            },
            // 캄보디아어
            km: {
                title: "គណនាអត្រាប្តូរប្រាក់",
                last_updated: "បានធ្វើបច្ចុប្បន្នភាពចុងក្រោយ:",
                mode_expense: "ចំណាយសរុប",
                mode_converter: "កម្មវិធីបំលែង",
                tip_expense: "💡 របៀបប្រើប្រាស់: រូបិយប័ណ្ណកំពូលគឺជាមូលដ្ឋាននៃផលបូក។ អូសដៃ (☰) ដើម្បីតម្រៀងឡើងវិញ និងបញ្ចូលការគណនាដូចជា `10+10-10%`!",
                tip_converter: "💡 គន្លឹះ: បញ្ចូលតម្លៃក្នុងរូបិយប័ណ្ណមួយដើម្បីបំលែងផ្សេងទៀត។",
                error_message: "បរាជ័យក្នុងការផ្ទុកអត្រាប្តូរប្រាក់។ សូមព្យាយាមម្តងទៀតពេលក្រោយ។",
                retry_button: "ព្យាយាមម្តងទៀត",
                total_sum: "សរុបទាំងអស់",
                reset_button: "កំណត់ឡើងវិញទាំងអស់",
                offline_mode: "របៀបក្រៅបណ្តាញ",
                blog_link: "ទស្សនាប្លក់របស់ខ្ញុំ",
            },
            // 포르투갈어
            pt: {
                title: "Conversor de Moedas",
                last_updated: "Última Atualização:",
                mode_expense: "Soma de Despesas",
                mode_converter: "Conversor",
                tip_expense: "💡 Como usar: A moeda superior é a base da soma. Arraste a alça (☰) para reordenar e insira cálculos como `10+10-10%`!",
                tip_converter: "💡 Dica: Digite um valor em uma moeda para converter todas as outras.",
                error_message: "Falha ao carregar as taxas de câmbio. Por favor, tente novamente mais tarde.",
                retry_button: "Tentar Novamente",
                total_sum: "Soma Total",
                reset_button: "Redefinir Todas as Entradas",
                offline_mode: "Modo Offline",
                blog_link: "Visitar meu blog",
            },
            // 다른 언어들 (스페인어, 프랑스어, 독일어, 아랍어)
            es: { /* 스페인어 번역 */ },
            fr: { /* 프랑스어 번역 */ },
            de: { /* 독일어 번역 */ },
            ar: { /* 아랍어 번역 */ },
        };

        // --------- 통화 데이터 ---------
        const targetCurrencies = {
            'KRW': { country: 'kr', name: '대한민국 원', symbol: '₩' },
            'JPY': { country: 'jp', name: '일본 엔', symbol: '¥' },
            'CNY': { country: 'cn', name: '중국 위안', symbol: '¥' },
            'HKD': { country: 'hk', name: '홍콩 달러', symbol: '$' },
            'SGD': { country: 'sg', name: '싱가포르 달러', symbol: '$' },
            'THB': { country: 'th', name: '태국 바트', symbol: '฿' },
            'VND': { country: 'vn', name: '베트남 동', symbol: '₫' },
            'IDR': { country: 'id', name: '인도네시아 루피아', symbol: 'Rp' },
            'PHP': { country: 'ph', name: '필리핀 페소', symbol: '₱' },
            'MYR': { country: 'my', name: '말레이시아 링깃', symbol: 'RM' },
            'INR': { country: 'in', name: '인도 루피', symbol: '₹' },
            'KHR': { country: 'kh', name: '캄보디아 리엘', symbol: '៛' },
            'LAK': { country: 'la', name: '라오스 킵', symbol: '₭' },
            'USD': { country: 'us', name: '미국 달러', symbol: '$' },
            'CAD': { country: 'ca', name: '캐나다 달러', symbol: '$' },
            'MXN': { country: 'mx', name: '멕시코 페소', symbol: '$' },
            'BRL': { country: 'br', name: '브라질 헤알', symbol: 'R$' },
            'ARS': { country: 'ar', name: '아르헨티나 페소', symbol: '$' },
            'CLP': { country: 'cl', name: '칠레 페소', symbol: '$' },
            'COP': { country: 'co', name: '콜롬비아 페소', symbol: '$' },
            'PEN': { country: 'pe', name: '페루 솔', symbol: 'S/.' },
            'EUR': { country: 'eu', name: '유럽 유로', symbol: '€' },
            'GBP': { country: 'gb', name: '영국 파운드', symbol: '£' },
            'CHF': { country: 'ch', name: '스위스 프랑', symbol: 'Fr' },
            'TRY': { country: 'tr', name: '터키 리라', symbol: '₺' },
            'PLN': { country: 'pl', name: '폴란드 즈워티', symbol: 'zł' },
            'CZK': { country: 'cz', name: '체코 코루나', symbol: 'Kč' },
            'HUF': { country: 'hu', name: '헝가리 포린트', symbol: 'Ft' },
            'BAM': { country: 'ba', name: '보스니아 마르카', symbol: 'KM' },
            'RSD': { country: 'rs', name: '세르비아 디나르', symbol: 'din' },
            'MKD': { country: 'mk', name: '북마케도니아 데나르', symbol: 'ден' },
            'ALL': { country: 'al', name: '알바니아 렉', symbol: 'L' },
            'BGN': { country: 'bg', name: '불가리아 레프', symbol: 'лв' },
            'RON': { country: 'ro', name: '루마니아 레우', symbol: 'lei' },
            'MDL': { country: 'md', name: '몰도바 레우', symbol: 'L' },
            'GEL': { country: 'ge', name: '조지아 라리', symbol: '₾' },
            'NOK': { country: 'no', name: '노르웨이 크로네', symbol: 'kr' },
            'SEK': { country: 'se', name: '스웨덴 크로나', symbol: 'kr' },
            'DKK': { country: 'dk', name: '덴마크 크로네', symbol: 'kr' },
            'AUD': { country: 'au', name: '호주 달러', symbol: '$' },
            'NZD': { country: 'nz', name: '뉴질랜드 달러', symbol: '$' },
            'AED': { country: 'ae', name: 'UAE 디르함', symbol: 'د.إ' },
            'ILS': { country: 'il', name: '이스라엘 셰켈', symbol: '₪' },
            'EGP': { country: 'eg', name: '이집트 파운드', symbol: 'E£' },
            'ZAR': { country: 'za', name: '남아공 랜드', symbol: 'R' },
        };

        // --------- 이벤트 리스너 ---------

        // 네트워크 연결 상태 감지
        window.addEventListener('online', () => {
            fetchRates(); // 온라인 상태가 되면 최신 환율 정보 가져오기
        });

        // 언어 변경 처리
        languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

        // 초기화
        function initializeApp() {
            // 저장된 통화 순서 불러오기
            loadCurrencyOrder();

            // 환율 정보 가져오기
            fetchRates();

            // 재시도 버튼에 이벤트 리스너 추가
            retryButton.addEventListener('click', () => fetchRates());
        }

        // --------- 로컬 스토리지 유틸리티 ---------

        // 안전하게 로컬 스토리지에서 데이터 가져오기
        function getSafeLocalStorage(key, defaultValue) {
            try {
                const value = localStorage.getItem(key);
                return value !== null ? value : defaultValue;
            } catch (e) {
                console.warn("localStorage 접근 오류:", e);
                return defaultValue;
            }
        }

        // 안전하게 로컬 스토리지에 데이터 저장하기
        function setSafeLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.warn("localStorage 저장 오류:", e);
                return false;
            }
        }

        // 통화 순서 불러오기
        function loadCurrencyOrder() {
            try {
                const savedOrder = getSafeLocalStorage('currencyOrder', null);
                if (savedOrder) {
                    const parsedOrder = JSON.parse(savedOrder);
                    // 저장된 통화가 모두 유효한지 확인
                    if (Array.isArray(parsedOrder) && parsedOrder.length > 0 &&
                        parsedOrder.every(code => targetCurrencies[code])) {
                        currencyOrder = parsedOrder;
                        return;
                    }
                }
                // 저장된 순서가 없거나 유효하지 않은 경우, 기본 순서 사용
                currencyOrder = Object.keys(targetCurrencies);
            } catch (e) {
                console.warn("저장된 통화 순서를 불러오는데 실패했습니다:", e);
                currencyOrder = Object.keys(targetCurrencies);
            }
        }

        // --------- API 호출 ---------

        // 환율 정보 가져오기 (재시도 로직 포함)
        async function fetchRates(retryCount = 3, delay = 1000) {
            showLoader();

            for (let i = 0; i < retryCount; i++) {
                try {
                    const response = await fetch('https://open.er-api.com/v6/latest/USD');

                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.result === 'success') {
                        // 환율 데이터 저장 및 UI 초기화
                        exchangeRates = data.rates;
                        lastUpdateTimeUTC = data.time_last_update_utc;
                        isOfflineMode = false;

                        // 로컬 스토리지에 캐싱
                        cacheExchangeRates(data);

                        // 사용자 언어 설정 로드
                        const savedLang = getSafeLocalStorage('preferredLanguage', 'ko');
                        languageSelector.value = savedLang;

                        // 기본 모드 설정
                        setMode(currentMode);
                        applyTranslations(savedLang);
                        addModeSwitchListeners();
                        showCalculator();
                        return;
                    } else {
                        throw new Error('API 오류: ' + (data.error || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error(`환율 정보 가져오기 실패 (시도 ${i+1}/${retryCount}):`, error);

                    if (i === retryCount - 1) {
                        // 모든 재시도 실패 시 캐시된 데이터 사용 시도
                        if (tryLoadCachedRates()) {
                            return;
                        }

                        showError();
                    } else {
                        // 지수 백오프를 사용하여 재시도 간격 증가
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    }
                }
            }
        }

        // 환율 정보 캐싱
        function cacheExchangeRates(data) {
            try {
                setSafeLocalStorage('cachedRates', JSON.stringify(data));
                setSafeLocalStorage('ratesTimestamp', Date.now().toString());
            } catch (e) {
                console.warn("캐시 저장 실패:", e);
            }
        }

        // 캐시된 환율 정보 불러오기
        function tryLoadCachedRates() {
            try {
                const cachedData = getSafeLocalStorage('cachedRates', null);
                if (cachedData) {
                    const parsedData = JSON.parse(cachedData);
                    exchangeRates = parsedData.rates;
                    lastUpdateTimeUTC = parsedData.time_last_update_utc;
                    isOfflineMode = true;

                    setMode(currentMode);
                    applyTranslations(currentLang);
                    addModeSwitchListeners();
                    showCalculator();
                    return true;
                }
            } catch (e) {
                console.error("캐시 데이터 사용 실패:", e);
            }
            return false;
        }

        // --------- 다국어 지원 ---------

        // 번역 적용
        function applyTranslations(lang) {
            // 데이터 속성을 기준으로 번역
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if(translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // 통화 카드 번역
            document.querySelectorAll('.currency-item').forEach(card => {
                const input = card.querySelector('.currency-input');
                if (!input) return;

                const code = input.dataset.currencyCode.toLowerCase();
                const nameEl = card.querySelector(`[data-translate-key="currency_name_${code}"]`);
                const pronEl = card.querySelector(`[data-translate-key="currency_pronunciation_${code}"]`);

                if(nameEl && translations[lang] && translations[lang][`currency_name_${code}`]) {
                    nameEl.textContent = translations[lang][`currency_name_${code}`];
                }
                if(pronEl && translations[lang] && translations[lang][`currency_pronunciation_${code}`]) {
                    pronEl.textContent = translations[lang][`currency_pronunciation_${code}`];
                }
            });

            // 최종 업데이트 시간 번역
            if(lastUpdateTimeUTC) {
                const updateDate = new Date(lastUpdateTimeUTC);
                const lastUpdatedPrefix = translations[lang].last_updated || "Last Updated:";
                let updatedText = `${lastUpdatedPrefix} ${updateDate.toLocaleString(lang)}`;

                // 오프라인 모드 표시
                if (isOfflineMode) {
                    updatedText += ` <span class="offline-indicator">${translations[lang].offline_mode || "Offline Mode"}</span>`;
                }

                lastUpdated.innerHTML = updatedText;
            }

            // UI 모드에 따른 번역 업데이트
            updateModeUI();
        }

        // 언어 설정
        function setLanguage(lang) {
            currentLang = lang;
            setSafeLocalStorage('preferredLanguage', lang);
            languageSelector.value = lang;
            document.documentElement.lang = lang;
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
            applyTranslations(lang);
        }

        // --------- 모드 관리 ---------

        // 모드 설정 (경비 합산/환율 변환)
        function setMode(newMode) {
            currentMode = newMode;
            buildCalculatorUI(); // DOM 재구성
            addDragDropListeners(); // 새 DOM에 리스너 추가
            applyTranslations(currentLang); // 새 DOM 번역
            updateModeUI();
        }

        // 모드 UI 업데이트
        function updateModeUI() {
            currencyListContainer.className = 'space-y-4';

            if(currentMode === 'expense') {
                modeExpenseBtn.classList.add('active');
                modeExpenseBtn.setAttribute('aria-pressed', 'true');
                modeConverterBtn.classList.remove('active');
                modeConverterBtn.setAttribute('aria-pressed', 'false');
                totalSummaryFooter.classList.remove('hidden');
                mainContent.style.paddingBottom = '8rem';
                modeTip.dataset.translateKey = 'tip_expense';
            } else {
                modeConverterBtn.classList.add('active');
                modeConverterBtn.setAttribute('aria-pressed', 'true');
                modeExpenseBtn.classList.remove('active');
                modeExpenseBtn.setAttribute('aria-pressed', 'false');
                totalSummaryFooter.classList.add('hidden');
                mainContent.style.paddingBottom = '2rem';
                modeTip.dataset.translateKey = 'tip_converter';
            }

            modeTip.textContent = translations[currentLang][modeTip.dataset.translateKey] || modeTip.dataset.translateKey;
        }

        // 모드 전환 버튼 리스너 추가
        function addModeSwitchListeners() {
            modeExpenseBtn.addEventListener('click', () => setMode('expense'));
            modeConverterBtn.addEventListener('click', () => setMode('converter'));
        }

        // --------- UI 구성 및 조작 ---------

        // 광고 컨테이너 생성
        function createAdPlaceholder() {
            const adContainer = document.createElement('div');
            adContainer.className = 'ad-container';
            adContainer.innerHTML = `<ins class="adsbygoogle" style="display:block" data-ad-format="auto" data-full-width-responsive="true" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="XXXXXXXXXX"></ins>`;
            return adContainer;
        }

        // 통화 카드 생성
        function createCurrencyCard(code) {
            const currency = targetCurrencies[code];
            const card = document.createElement('div');

            const inputElement = currentMode === 'expense'
                ? `<textarea class="autoresize-textarea currency-input w-full bg-white text-right font-semibold text-lg text-gray-800 rounded-md py-2 pl-8 pr-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-currency-code="${code}" placeholder="0" rows="1" aria-label="${code} 금액 입력"></textarea>`
                : `<input type="text" inputmode="decimal" class="currency-input w-full bg-white text-right font-semibold text-lg text-gray-800 rounded-md py-2 pl-8 pr-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-currency-code="${code}" placeholder="0.00" aria-label="${code} 금액 입력">`;

            card.className = `flex items-center gap-3 p-3 bg-gray-50 rounded-xl border-2 border-transparent transition-shadow duration-300 currency-item`;
            card.innerHTML = `<div class="drag-handle p-2" aria-label="통화 순서 변경" role="button" tabindex="0"><svg class="w-6 h-6 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div>
                    <div class="flex flex-col items-center w-14 text-center">
                        <img src="https://flagcdn.com/w40/${currency.country}.png" alt="${code}" class="w-10 h-10 rounded-full shadow-sm" onerror="this.style.display='none'">
                        <p class="text-xs text-gray-500 mt-1 w-full truncate" data-translate-key="currency_name_${code.toLowerCase()}">${currency.name}</p>
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800">${code}</p>
                        <p class="text-xs text-gray-500" data-translate-key="currency_pronunciation_${code.toLowerCase()}"></p>
                    </div>
                    <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg">${currency.symbol}</span>${inputElement}</div>`;
            return card;
        }

        // 계산기 UI 구성
        function buildCalculatorUI() {
            currencyListContainer.innerHTML = '';
            const finalOrder = currencyOrder;

            finalOrder.forEach((code, index) => {
                currencyListContainer.appendChild(createCurrencyCard(code));
                // 광고 삽입 (5번째와 15번째 위치)
                if (currentMode === 'expense' && (index === 5 || index === 15)) {
                    currencyListContainer.appendChild(createAdPlaceholder());
                }
            });

            // 입력 이벤트 리스너 추가
            addInputListeners();

            // 리셋 버튼 기능
            if (currentMode === 'expense') {
                resetButton.onclick = resetAllInputs;
            }

            // 광고 스크립트 실행
            initializeAdsense();

            updateBaseRateDisplay();
        }

        // 입력 이벤트 리스너 추가
        function addInputListeners() {
            document.querySelectorAll('.currency-input').forEach(input => {
                if(currentMode === 'expense') {
                    input.addEventListener('input', (e) => {
                        updateTotalAmount();
                        autoResizeTextarea(e.target);
                    });
                } else {
                    input.addEventListener('input', handleConverterInput);
                }
            });
        }

        // 모든 입력 초기화
        function resetAllInputs() {
            document.querySelectorAll('.currency-input').forEach(input => {
                input.value = '';
                autoResizeTextarea(input);
            });
            updateTotalAmount();
        }

        // AdSense 초기화
        function initializeAdsense() {
            setTimeout(() => {
                document.querySelectorAll('.adsbygoogle').forEach(ad => {
                    if (ad.innerHTML.trim().length > 0) return;
                    try {
                        (window.adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) {
                        if(ad.parentElement) ad.parentElement.style.display = 'none';
                        console.error("AdSense push error:", e);
                    }
                });
            }, 150);
        }

        // textarea 높이 자동 조절
        function autoResizeTextarea(textarea) {
            if (textarea && textarea.tagName && textarea.tagName.toLowerCase() === 'textarea') {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }

        // --------- 드래그 앤 드롭 관리 ---------

        // 드래그 앤 드롭 리스너 추가
        function addDragDropListeners() {
            const container = document.getElementById('currency-list');
            if (!container) return;

            let draggingEl = null;
            let initialY = 0;
            let initialScroll = 0;

            // 포인터 다운(터치/마우스) 이벤트 처리
            const onPointerDown = (e) => {
                const handle = e.target.closest('.drag-handle');
                if (!handle) return;

                draggingEl = handle.closest('.currency-item');
                if (!draggingEl) return;

                // 기본 동작 방지
                if (e.type === 'touchstart') e.preventDefault();

                // 초기 위치 기록
                initialY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                initialScroll = window.scrollY;

                // 드래그 스타일 적용
                draggingEl.classList.add('dragging');
                document.body.classList.add('is-dragging');

                // 이벤트 리스너 등록
                if (e.type === 'mousedown') {
                    document.addEventListener('mousemove', onPointerMove);
                    document.addEventListener('mouseup', onPointerUp);
                } else { // touchstart
                    document.addEventListener('touchmove', onPointerMove, { passive: false });
                    document.addEventListener('touchend', onPointerUp);
                }

                // 포커스된 요소가 있으면 블러 처리
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
            };

            // 포인터 움직임 처리
            const onPointerMove = (e) => {
                if (!draggingEl) return;
                e.preventDefault();

                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const afterElement = getDragAfterElement(container, clientY);

                if (afterElement) {
                    container.insertBefore(draggingEl, afterElement);
                } else {
                    container.appendChild(draggingEl);
                }

                // 화면 자동 스크롤
                handleAutoscroll(clientY);
            };

            // 자동 스크롤 처리
            const handleAutoscroll = (clientY) => {
                const scrollThreshold = 150;
                const viewportHeight = window.innerHeight;

                if (clientY < scrollThreshold) {
                    // 위로 스크롤
                    window.scrollBy(0, -10);
                } else if (clientY > viewportHeight - scrollThreshold) {
                    // 아래로 스크롤
                    window.scrollBy(0, 10);
                }
            };

            // 포인터 업 이벤트 처리
            const onPointerUp = () => {
                if (!draggingEl) return;

                // 스타일 및 클래스 제거
                draggingEl.classList.remove('dragging');
                document.body.classList.remove('is-dragging');

                // 현재 순서 저장
                saveCurrencyOrder();

                // 관련 UI 업데이트
                updateBaseRateDisplay();
                updateTotalAmount();

                draggingEl = null;

                // 이벤트 리스너 제거
                document.removeEventListener('mousemove', onPointerMove);
                document.removeEventListener('mouseup', onPointerUp);
                document.removeEventListener('touchmove', onPointerMove);
                document.removeEventListener('touchend', onPointerUp);
            };

            // 현재 통화 순서 저장
            const saveCurrencyOrder = () => {
                currencyOrder = Array.from(container.querySelectorAll('.currency-item'))
                    .map(item => item.querySelector('.currency-input').dataset.currencyCode);

                // 로컬 스토리지에 통화 순서 저장
                setSafeLocalStorage('currencyOrder', JSON.stringify(currencyOrder));
            };

            // 드래그 핸들에 키보드 접근성 추가
            container.querySelectorAll('.drag-handle').forEach(handle => {
                // 터치 이벤트 처리
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, { passive: false });

                // 키보드 접근성 (Enter 또는 Space로 이동)
                handle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();

                        const item = handle.closest('.currency-item');
                        const sibling = e.shiftKey ? item.previousElementSibling : item.nextElementSibling;

                        if (sibling && sibling.classList.contains('currency-item')) {
                            if (e.shiftKey) {
                                container.insertBefore(item, sibling);
                            } else {
                                container.insertBefore(sibling, item);
                            }

                            // 순서 업데이트
                            saveCurrencyOrder();
                            updateBaseRateDisplay();
                            updateTotalAmount();

                            // 핸들에 다시 포커스
                            setTimeout(() => {
                                handle.focus();
                            }, 10);
                        }
                    }
                });
            });

            // 컨테이너에 드래그 이벤트 리스너 추가
            container.addEventListener('mousedown', onPointerDown);
            container.addEventListener('touchstart', onPointerDown, { passive: false });
        }

        // 드래그 앤 드롭 요소 위치 계산
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.currency-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --------- 계산 관련 기능 ---------

        // 안전한 수식 계산 함수
        function evaluateExpression(str) {
            if (!str || str.trim() === '') return 0;

            // 위험한 문자 제거
            let evalStr = str.replace(/[\n\r]/g, ' ')
                .replace(/[^0-9\.\+\-\*\/\(\)\%\s]/g, '')
                .trim();

            // 끝에 연산자가 있으면 제거
            if (/[+\-*/]$/.test(evalStr)) evalStr = evalStr.slice(0, -1).trim();

            if (evalStr === '') return 0;

            // 백분율 계산 처리
            evalStr = evalStr.replace(/(\d*\.?\d+)\s*([+\-])\s*(\d*\.?\d+)\s*%/g,
                (m, p1, p2, p3) => `${p1} ${p2} (${p1} * ${p3} / 100)`);

            evalStr = evalStr.replace(/(\d*\.?\d+)\s*%/g, '( $1 / 100 )');

            try {
                // 안전한 수학 표현식 계산
                return calculateMathExpression(evalStr);
            } catch (e) {
                console.error("계산 오류:", e);
                return 0;
            }
        }

        // 안전한 수학 표현식 계산기
        function calculateMathExpression(expression) {
            // 괄호 처리
            while (expression.includes('(') && expression.includes(')')) {
                expression = expression.replace(/\(([^()]+)\)/g, (match, expr) => {
                    return calculateMathExpression(expr);
                });
            }

            // 연산자 우선순위에 따라 계산
            // 1. 곱셈과 나눗셈
            let result = expression;
            while (/(\d+\.?\d*)\s*([*/])\s*(\d+\.?\d*)/.test(result)) {
                result = result.replace(/(\d+\.?\d*)\s*([*/])\s*(\d+\.?\d*)/, (match, a, op, b) => {
                    a = parseFloat(a);
                    b = parseFloat(b);
                    return op === '*' ? a * b : a / b;
                });
            }

            // 2. 덧셈과 뺄셈
            while (/(\d+\.?\d*)\s*([+\-])\s*(\d+\.?\d*)/.test(result)) {
                result = result.replace(/(\d+\.?\d*)\s*([+\-])\s*(\d+\.?\d*)/, (match, a, op, b) => {
                    a = parseFloat(a);
                    b = parseFloat(b);
                    return op === '+' ? a + b : a - b;
                });
            }

            return parseFloat(result) || 0;
        }

        // 기준 환율 표시 업데이트
        function updateBaseRateDisplay() {
            const firstCardInput = document.querySelector('#currency-list .currency-input');
            if (!firstCardInput) return;

            const baseCode = firstCardInput.dataset.currencyCode;
            let quoteCode = 'USD';

            if (baseCode === 'USD') quoteCode = 'EUR';

            if (!exchangeRates[quoteCode] || !exchangeRates[baseCode]) return;

            const rate = exchangeRates[quoteCode] / exchangeRates[baseCode];
            baseRateDisplay.textContent = `1 ${baseCode} = ${rate.toFixed(4)} ${quoteCode}`;
        }

        // 총액 업데이트
        function updateTotalAmount() {
            if (currentMode !== 'expense') return;

            const firstCardInput = document.querySelector('#currency-list .currency-input');
            if (!firstCardInput) return;

            const baseCurrencyCode = firstCardInput.dataset.currencyCode;
            let totalUSD = 0;

            // 모든 통화의 입력값을 USD로 변환하여 합산
            document.querySelectorAll('.currency-input').forEach(input => {
                const code = input.dataset.currencyCode;
                const value = evaluateExpression(input.value);

                if (!isNaN(value) && value > 0) {
                    if (exchangeRates[code]) {
                        totalUSD += value / exchangeRates[code];
                    }
                }
            });

            // USD 합계를 기준 통화로 변환
            if (!exchangeRates[baseCurrencyCode]) return;

            const totalInBaseCurrency = totalUSD * exchangeRates[baseCurrencyCode];
            const baseSymbol = targetCurrencies[baseCurrencyCode].symbol;

            // 합계 표시 (천 단위 구분)
            totalAmountDisplay.textContent = `${baseSymbol} ${Math.round(totalInBaseCurrency).toLocaleString('ko-KR')}`;
        }

        // 환율 변환 모드 입력 처리
        function handleConverterInput(event) {
            const sourceInput = event.target;
            const sourceCode = sourceInput.dataset.currencyCode;
            const sourceValue = parseFloat(sourceInput.value.replace(/,/g, ''));

            // 비어있거나 유효하지 않은 입력일 경우 다른 입력칸 비우기
            if(isNaN(sourceValue)) {
                document.querySelectorAll('.currency-input').forEach(input => {
                    if(input !== sourceInput) input.value = '';
                });
                return;
            }

            // 입력된 값을 USD로 변환
            const sourceValueInUSD = sourceValue / exchangeRates[sourceCode];

            // USD 기준으로 다른 모든 통화 변환
            document.querySelectorAll('.currency-input').forEach(input => {
                if(input !== sourceInput) {
                    const targetCode = input.dataset.currencyCode;
                    if(!exchangeRates[targetCode]) return;

                    const targetValue = sourceValueInUSD * exchangeRates[targetCode];

                    // 소수점 둘째 자리까지 표시, 천 단위 구분
                    input.value = targetValue.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            });
        }

        // UI 상태 함수들
        function showLoader() {
            loader.classList.remove('hidden');
            calculator.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showCalculator() {
            loader.classList.add('hidden');
            errorMessage.classList.add('hidden');
            calculator.classList.remove('hidden');
        }

        function showError() {
            loader.classList.add('hidden');
            calculator.classList.add('hidden');
            errorMessage.classList.remove('hidden');
        }

        // 앱 초기 실행
        initializeApp();
    });
</script>
</body>
</html>
